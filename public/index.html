<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShowCase Pro - V61</title>
    
    <link rel="icon" href="data:,">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>window.jsPDF = window.jspdf.jsPDF;</script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script> 
    
    <script src="https://cdn.jsdelivr.net/npm/@phosphor-icons/web"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="report-generator.js"></script> 
    
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Roboto', 'sans-serif'], display: ['Montserrat', 'sans-serif'] }, colors: { swc: { primary: '#85B433', secondary: '#34B0B1', sidebar: '#003E3F', orange: '#CD6619', brown: '#8B4513', gray: '#334155', surface: '#f8fafc' }, sem: { success: '#33B841', error: '#F6242A', alert: '#F66E00', info: '#A0B6D9' } }, animation: { 'fade-in': 'fadeIn 0.3s ease-in-out' }, keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } } } } }
    </script>
    <style>
        h1, h2, h3, h4, .tv-number, .font-display { font-family: 'Montserrat', sans-serif; } body { font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; } .step-content { display: none; } .step-content.active { display: block; animation: fadeIn 0.3s ease-in-out; } .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; } .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; } .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; } .details-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, opacity 0.3s ease-out; opacity: 0; } .details-content.open { max-height: 1000px; opacity: 1; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f1f5f9; } .chevron-icon { transition: transform 0.3s; } .chevron-icon.rotate { transform: rotate(180deg); } .field-hidden { display: none !important; } .field-required label::after { content: " *"; color: #F6242A; } 
        @media (max-width: 768px) { input, select, button { min-height: 44px; } .view-section { padding: 1rem !important; } h2.text-2xl { font-size: 1.25rem; } #modal-content { height: 100% !important; max-height: 100% !important; border-radius: 0 !important; } } 
        body.tv-mode aside, body.tv-mode header, body.tv-mode nav { display: none !important; } body.tv-mode main { height: 100vh; padding: 0; background-color: #0b0c15; color: white; padding-bottom: 0 !important; } body.tv-mode .view-section { max-width: 100%; padding: 2rem; height: 100vh; overflow: hidden; } body.tv-mode .bg-white { background-color: #151621 !important; border-color: #2d2f3f !important; color: white !important; } body.tv-mode .text-slate-800 { color: white !important; } body.tv-mode .text-slate-500 { color: #94a3b8 !important; } body.tv-mode .tv-number { font-family: 'Montserrat', sans-serif; color: #85B433; text-shadow: 0 0 10px rgba(133, 180, 51, 0.4); } body.tv-mode #exit-tv-btn { display: block; } .live-dot { width: 8px; height: 8px; background-color: #F6242A; border-radius: 50%; animation: pulse 2s infinite; } @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(246, 36, 42, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(246, 36, 42, 0); } }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 font-sans h-screen flex overflow-hidden hidden" id="app-body">
    <button id="exit-tv-btn" onclick="toggleTVMode()" class="fixed top-4 right-4 z-50 bg-sem-error text-white p-3 rounded-full opacity-0 hover:opacity-100 transition hidden shadow-xl border-2 border-white" title="Sair do Modo TV"><i class="ph ph-x text-xl"></i></button>

    <aside class="hidden md:flex w-64 bg-swc-sidebar text-white flex-col shadow-2xl z-30 flex-shrink-0">
        <div class="h-20 flex items-center justify-center px-6 border-b border-white/10">
            <img src="showcase.png" alt="Logo ShowCase" class="max-h-10 w-auto object-contain drop-shadow-md hover:scale-105 transition-transform duration-300">
        </div>
        <div class="px-6 py-4 border-b border-white/10 bg-white/5"><div class="flex items-center gap-3"><div class="w-9 h-9 rounded-full bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center font-bold text-swc-primary border border-white/10 shadow-inner" id="user-avatar">U</div><div class="overflow-hidden"><p class="text-sm font-bold text-white truncate" id="user-name">...</p><p class="text-[10px] text-gray-400 truncate uppercase tracking-wider" id="user-role">...</p></div></div></div>
        <nav class="flex-1 py-4 px-3 space-y-1 overflow-y-auto custom-scrollbar">
            <p class="px-3 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 mt-2" id="label-nav-overview">Visão Geral</p>
            <button onclick="navigateTo('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 hover:bg-white/10 hover:text-white transition-all"><i class="ph ph-chart-pie-slice text-lg"></i><span class="text-sm font-medium">Relatórios</span></button>
            <p class="px-3 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 mt-4" id="label-nav-orders">Comercial</p>
            <button onclick="navigateTo('orders')" id="nav-orders" class="nav-btn w-full flex items-center justify-between px-3 py-2.5 rounded-lg text-slate-300 hover:bg-white/10 hover:text-white transition-all group">
                <div class="flex items-center gap-3"><i class="ph ph-shopping-cart text-lg group-hover:scale-110 transition-transform"></i><span class="text-sm font-medium">Solicitações</span></div>
                <span id="badge-orders-desktop" class="hidden bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full shadow-[0_0_8px_rgba(239,68,68,0.6)] animate-pulse border border-red-400">0</span>
            </button>
            <button onclick="navigateTo('status')" id="nav-status" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 hover:bg-white/10 hover:text-white transition-all text-swc-secondary"><i class="ph ph-monitor-play text-lg"></i><span class="text-sm font-medium">Status Produção</span></button>
            <button onclick="navigateTo('finished')" id="nav-finished" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 hover:bg-white/10 hover:text-white transition-all text-sem-success"><i class="ph ph-package text-lg"></i><span class="text-sm font-medium">Finalizados</span></button>
            <p class="px-3 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 mt-4" id="label-nav-production">Produção</p>
            <button onclick="navigateTo('pokeball')" id="nav-pokeball" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 hover:bg-white/10 hover:text-white transition-all group"><i class="ph ph-hard-drives text-lg group-hover:text-swc-primary"></i><span class="text-sm font-medium">Servidores</span></button>
            <button onclick="navigateTo('rotom')" id="nav-rotom" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 hover:bg-white/10 hover:text-white transition-all"><i class="ph ph-check-square-offset text-lg"></i><span class="text-sm font-medium">Tarefas</span></button>
            <p class="px-3 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 mt-4" id="label-nav-management">Gestão</p>
            <button onclick="navigateTo('rotines')" id="nav-rotines" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 hover:bg-white/10 hover:text-white transition-all"><i class="ph ph-arrows-clockwise text-lg"></i><span class="text-sm font-medium">Rotinas</span></button>
            <button onclick="navigateTo('tm')" id="nav-tm" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 hover:bg-white/10 hover:text-white transition-all"><i class="ph ph-book-bookmark text-lg"></i><span class="text-sm font-medium">Manuais</span></button>
            <button onclick="navigateTo('team')" id="nav-team" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 hover:bg-white/10 hover:text-white transition-all"><i class="ph ph-users text-lg"></i><span class="text-sm font-medium">Equipe</span></button>
            <p class="px-3 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 mt-4" id="label-nav-diag">Diagnóstico</p>
            <button onclick="navigateTo('logs')" id="nav-logs" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-red-300 hover:bg-white/10 hover:text-white transition-all"><i class="ph ph-bug text-lg"></i><span class="text-sm font-medium">Logs do Servidor</span></button>
            <button onclick="navigateTo('settings')" id="nav-settings" class="nav-btn w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-300 hover:bg-white/10 hover:text-white transition-all"><i class="ph ph-sliders text-lg"></i><span class="text-sm font-medium">Configurações</span></button>
        </nav>
        <div class="p-4 border-t border-white/10"><button onclick="logout()" class="w-full flex items-center gap-2 text-red-300 hover:text-red-200 text-sm px-3 py-2 rounded-lg hover:bg-sem-error/20 transition"><i class="ph ph-sign-out text-lg"></i> Sair</button></div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative transition-all duration-500 pb-24 md:pb-0">
        <header class="md:flex h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 md:px-8 shadow-sm z-10 flex-shrink-0">
            <div id="header-left" class="flex items-center gap-4"></div>
            <div class="flex items-center gap-4">
                <div class="relative">
                    <button onclick="toggleNotifications(event)" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-slate-600 transition relative outline-none focus:ring-2 focus:ring-swc-secondary/50">
                        <i class="ph ph-bell text-xl"></i>
                        <span id="notif-badge" class="absolute top-0.5 right-0.5 w-3 h-3 bg-sem-error border-2 border-white rounded-full hidden"></span>
                    </button>
                    <div id="notif-dropdown" class="hidden absolute top-12 right-0 w-80 bg-white border border-gray-200 shadow-2xl rounded-xl z-50 overflow-hidden flex flex-col transform transition-all">
                        <div class="p-3 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                            <span class="font-bold text-sm text-slate-700 font-display"><i class="ph ph-bell-ringing text-swc-primary mr-1"></i> Notificações</span>
                            <button onclick="markAllRead()" class="text-[10px] text-swc-secondary font-bold hover:underline">Marcar lidas</button>
                        </div>
                        <div id="notif-list" class="max-h-80 overflow-y-auto custom-scrollbar bg-white">
                            <div class="p-6 text-center text-slate-400 text-xs"><i class="ph ph-spinner animate-spin text-2xl mb-2"></i><br>Carregando...</div>
                        </div>
                    </div>
                </div>
                <div id="header-action"></div>
            </div>
        </header>
        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth relative custom-scrollbar">
            <div id="view-dashboard" class="view-section hidden max-w-7xl mx-auto fade-in"><div class="flex justify-between items-end mb-6"><div><h2 class="text-2xl font-display font-bold text-slate-800 tv-title">Visão Geral do Dia</h2><p class="text-sm text-slate-500 tv-text flex items-center gap-2"><span class="live-dot"></span> Atualizado em tempo real</p></div><button onclick="toggleTVMode()" class="hidden md:flex bg-swc-sidebar text-white px-4 py-2 rounded-lg hover:bg-black transition items-center gap-2 text-sm font-bold shadow-lg"><i class="ph ph-television"></i> Modo TV</button></div><div class="bg-white border border-swc-secondary/20 p-4 rounded-xl mb-6 flex items-start gap-3 shadow-sm"><div class="bg-swc-secondary/10 text-swc-secondary p-2 rounded-lg"><i class="ph ph-calendar-check text-xl font-bold"></i></div><div><h4 class="font-bold text-slate-700 text-sm mb-1 font-display">Acompanhamento Diário (Hoje)</h4><div class="flex flex-col sm:flex-row gap-2 sm:gap-4 text-xs text-slate-600"><span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-sem-alert"></span><strong>Pendências:</strong> A fazer.</span><span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full bg-sem-success"></span><strong>Concluídas:</strong> Finalizadas.</span></div></div></div><div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm tv-card flex items-center gap-5"><div class="w-14 h-14 rounded-full bg-swc-secondary/10 text-swc-secondary flex items-center justify-center text-3xl"><i class="ph ph-hard-drives"></i></div><div><h4 class="text-4xl font-display font-bold text-slate-800 tv-number" id="dash-servers-count">0</h4><p class="text-xs text-slate-500 font-bold uppercase tv-text">Em Produção</p></div></div><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm tv-card flex items-center gap-5"><div class="w-14 h-14 rounded-full bg-sem-alert/10 text-sem-alert flex items-center justify-center text-3xl"><i class="ph ph-warning-circle"></i></div><div><h4 class="text-4xl font-display font-bold text-slate-800 tv-number" id="dash-tasks-pending">0</h4><p class="text-xs text-slate-500 font-bold uppercase tv-text">Pendências Hoje</p></div></div><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm tv-card flex items-center gap-5"><div class="w-14 h-14 rounded-full bg-swc-sidebar/10 text-swc-sidebar flex items-center justify-center text-3xl"><i class="ph ph-users"></i></div><div><h4 class="text-4xl font-display font-bold text-slate-800 tv-number" id="dash-team-count">0</h4><p class="text-xs text-slate-500 font-bold uppercase tv-text">Equipe</p></div></div><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm tv-card flex items-center gap-5"><div class="w-14 h-14 rounded-full bg-sem-success/10 text-sem-success flex items-center justify-center text-3xl"><i class="ph ph-check-circle"></i></div><div><h4 class="text-4xl font-display font-bold text-slate-800 tv-number" id="dash-tasks-done">0</h4><p class="text-xs text-slate-500 font-bold uppercase tv-text">Concluídas Hoje</p></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8"><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm tv-card"><h4 class="font-bold text-slate-700 mb-4 uppercase text-xs tracking-wider tv-text font-display">Distribuição de Status</h4><div class="h-64 relative"><canvas id="chartServers"></canvas></div></div><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm tv-card"><h4 class="font-bold text-slate-700 mb-4 uppercase text-xs tracking-wider tv-text font-display">Carga de Trabalho (Hoje)</h4><div class="h-64 relative"><canvas id="chartTeam"></canvas></div></div></div><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm tv-card"><div class="flex justify-between items-center mb-4"><h4 class="font-bold text-slate-700 uppercase text-xs tracking-wider tv-text font-display">Últimas Movimentações</h4><select id="dash-filter" onchange="loadDashboardData()" class="text-xs border border-gray-300 rounded-lg p-1.5 outline-none focus:ring-1 focus:ring-swc-secondary bg-gray-50 text-slate-600 font-medium"><option value="Todos">Todos</option><option value="Produção">Em Produção</option><option value="Concluído">Concluídos</option></select></div><div id="dash-server-list" class="space-y-3"></div></div></div>
            <div id="view-orders" class="view-section hidden max-w-7xl mx-auto fade-in"><div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-6 border-b border-gray-200 pb-4 gap-4"><div><h3 class="text-2xl font-display font-bold text-slate-800">Solicitações Comerciais</h3><p class="text-sm text-slate-500">Gestão de pedidos e ordens de montagem.</p></div><div class="flex gap-2 w-full md:w-auto"><input type="text" id="order-search" placeholder="Buscar cliente..." onkeyup="applyOrderFilter()" class="border p-2 rounded text-sm outline-none focus:ring-1 focus:ring-swc-primary w-full md:w-64"><select id="order-filter" onchange="applyOrderFilter()" class="border p-2 rounded text-sm bg-white outline-none font-bold text-slate-600"><option value="Todos">Todos</option><option value="Pendente" selected>Pendentes</option><option value="Em Produção">Em Produção</option><option value="Concluído">Concluídos</option></select></div></div><div id="orders-container" class="grid grid-cols-1 gap-4 pb-12"></div></div>
            <div id="view-status" class="view-section hidden max-w-7xl mx-auto fade-in"><div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-6 border-b border-gray-200 pb-4 gap-4"><div><h3 class="text-2xl font-display font-bold text-slate-800">Status de Produção (Tempo Real)</h3><p class="text-sm text-slate-500">Acompanhamento de montagem para emissão antecipada de NF.</p></div><div class="flex gap-2 w-full md:w-auto"><input type="text" id="status-search" placeholder="Buscar cliente ou serial..." onkeyup="renderStatusPanel()" class="border border-swc-secondary/30 p-2 rounded text-sm outline-none focus:ring-2 focus:ring-swc-secondary/50 w-full md:w-72 shadow-sm"></div></div><div id="status-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-12"></div></div>
            <div id="view-finished" class="view-section hidden max-w-7xl mx-auto fade-in">
                <div class="flex flex-col md:flex-row gap-3 mb-6">
                    <input type="text" id="finished-search" onkeyup="renderFinishedPanel()" placeholder="Buscar cliente, serial ou modelo..." class="flex-1 border border-gray-300 rounded-xl p-3 outline-none focus:border-swc-primary focus:ring-1 focus:ring-swc-primary shadow-sm text-sm">
                            
                    <select id="finished-contract-filter" onchange="renderFinishedPanel()" class="border border-gray-300 rounded-xl p-3 outline-none focus:border-swc-primary shadow-sm text-sm bg-white">
                        <option value="">Todos os Contratos</option>
                        </select>
                            
                    <select id="finished-product-filter" onchange="renderFinishedPanel()" class="border border-gray-300 rounded-xl p-3 outline-none focus:border-swc-primary shadow-sm text-sm bg-white">
                        <option value="">Todos os Equipamentos</option>
                        </select>
                </div>
                <div id="finished-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-12"></div>
            </div>
            <div id="view-logs" class="view-section hidden max-w-full mx-auto fade-in"><div class="flex justify-between items-end mb-6"><div><h3 class="text-2xl font-display font-bold text-slate-800">Logs do Servidor</h3></div></div><div class="bg-black text-white p-4 rounded-xl shadow-lg h-[70vh] overflow-y-scroll font-mono text-xs"><pre id="logs-output">Carregando logs...</pre></div></div>            
            <div id="view-pokeball" class="view-section hidden max-w-full mx-auto fade-in"><div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-6 border-b border-gray-200 pb-4 gap-4"><div><h3 class="text-2xl font-display font-bold text-slate-800">Linha de Produção</h3><p class="text-sm text-slate-500">Acompanhamento de montagem.</p></div><div class="flex gap-2 w-full md:w-auto"><input type="text" id="server-search" placeholder="Buscar..." onkeyup="applyServerFilter()" class="border p-2 rounded text-sm outline-none focus:ring-1 focus:ring-swc-primary w-full md:w-64"><select id="server-filter" onchange="applyServerFilter()" class="border p-2 rounded text-sm bg-white outline-none"><option value="Produção">Em Produção</option><option value="Concluído">Concluídos</option><option value="Todos">Todos</option></select></div></div><div id="servers-container" class="space-y-4 pb-12"></div></div>
            <div id="view-rotom" class="view-section hidden max-w-7xl mx-auto fade-in"><div id="tasks-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-12"></div></div>
            <div id="view-rotines" class="view-section hidden max-w-6xl mx-auto fade-in"><div id="rotines-list-container" class="grid grid-cols-1 gap-4 pb-12"></div></div>
            <div id="view-tm" class="view-section hidden max-w-6xl mx-auto fade-in"><div id="manuals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-12"></div></div>
            <div id="view-team" class="view-section hidden max-w-6xl mx-auto fade-in"><div id="team-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 pb-12"></div></div>
            <div id="view-settings" class="view-section hidden max-w-6xl mx-auto fade-in"><div class="mb-8 bg-white p-6 rounded-xl border border-gray-200 shadow-sm"><h3 class="text-lg font-bold font-display text-slate-800 mb-2 flex items-center gap-2"><i class="ph ph-conveyor-belt text-swc-primary text-2xl"></i> Gerenciador de Fluxos</h3><div class="flex flex-col md:flex-row gap-4 mb-4"><select id="settings-workflow-select" class="border p-2 rounded text-sm bg-gray-50 w-full md:w-64" onchange="loadWorkflowEditor(this.value)"><option value="">Selecione uma finalidade...</option></select><button onclick="saveCurrentWorkflow()" class="bg-swc-sidebar text-white px-4 py-2 rounded text-sm font-bold hover:bg-black transition">Salvar Fluxo</button></div><div id="workflow-editor" class="hidden bg-gray-50 p-4 rounded border border-gray-200"><ul id="workflow-steps-list" class="space-y-3 mb-4"></ul><div class="flex gap-2"><input type="text" id="new-step-name" placeholder="Nome da nova etapa" class="border p-2 rounded text-sm flex-1"><button onclick="addWorkflowStep()" class="bg-swc-secondary text-white px-3 py-1 rounded text-sm hover:brightness-110">Adicionar</button></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-8 pb-12" id="settings-grid"><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm"><h4 class="font-bold text-slate-800 mb-4 flex justify-between font-display">Produtos <button onclick="addOption('product')" class="text-xs bg-swc-sidebar text-white px-2 py-1 rounded hover:bg-black">+ Add</button></h4><ul id="list-product" class="space-y-2 text-sm max-h-40 overflow-y-auto custom-scrollbar"></ul></div><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm"><h4 class="font-bold text-slate-800 mb-4 flex justify-between font-display">Serviços Adicionais <button onclick="addOption('service')" class="text-xs bg-swc-sidebar text-white px-2 py-1 rounded hover:bg-black">+ Add</button></h4><ul id="list-service" class="space-y-2 text-sm max-h-40 overflow-y-auto custom-scrollbar"></ul></div><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm"><h4 class="font-bold text-slate-800 mb-4 flex justify-between font-display">Finalidades <button onclick="addOption('purpose')" class="text-xs bg-swc-sidebar text-white px-2 py-1 rounded hover:bg-black">+ Add</button></h4><ul id="list-purpose" class="space-y-2 text-sm max-h-40 overflow-y-auto custom-scrollbar"></ul></div><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm"><h4 class="font-bold text-slate-800 mb-4 flex justify-between font-display">Fabricantes <button onclick="addOption('vendor')" class="text-xs bg-swc-sidebar text-white px-2 py-1 rounded hover:bg-black">+ Add</button></h4><ul id="list-vendor" class="space-y-2 text-sm max-h-40 overflow-y-auto custom-scrollbar"></ul></div><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm"><h4 class="font-bold text-slate-800 mb-4 flex justify-between font-display">Sistemas Operacionais <button onclick="addOption('os')" class="text-xs bg-swc-sidebar text-white px-2 py-1 rounded hover:bg-black">+ Add</button></h4><ul id="list-os" class="space-y-2 text-sm max-h-40 overflow-y-auto custom-scrollbar"></ul></div><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm"><h4 class="font-bold text-slate-800 mb-4 flex justify-between font-display">Categorias de Manual <button onclick="addOption('tm_category')" class="text-xs bg-swc-sidebar text-white px-2 py-1 rounded hover:bg-black">+ Add</button></h4><ul id="list-tm_category" class="space-y-2 text-sm max-h-40 overflow-y-auto custom-scrollbar"></ul></div><div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm"><h4 class="font-bold text-slate-800 mb-4 flex justify-between font-display">Tipos de Placa <button onclick="addOption('card_type')" class="text-xs bg-swc-sidebar text-white px-2 py-1 rounded hover:bg-black">+ Add</button></h4><ul id="list-card_type" class="space-y-2 text-sm max-h-40 overflow-y-auto custom-scrollbar"></ul></div></div></div>
        </div>
    </main>

    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-swc-sidebar text-white flex justify-around items-center p-3 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] border-t border-white/10">
        <button id="mobile-nav-dashboard" onclick="navigateTo('dashboard')" class="flex flex-col items-center gap-1 text-slate-300 hover:text-white transition"><i class="ph ph-chart-pie-slice text-2xl"></i><span class="text-[10px] font-bold">Visão</span></button>
        <button id="mobile-nav-orders" onclick="navigateTo('orders')" class="flex flex-col items-center gap-1 text-slate-300 hover:text-white transition relative">
            <div class="relative">
                <i class="ph ph-shopping-cart text-2xl"></i>
                <span id="badge-orders-mobile" class="hidden absolute -top-1.5 -right-2 bg-red-500 text-white text-[9px] font-bold w-4 h-4 items-center justify-center rounded-full shadow-[0_0_8px_rgba(239,68,68,0.6)] border border-swc-sidebar z-10">0</span>
            </div>
            <span class="text-[10px] font-bold">Vendas</span>
        </button>
        <button id="mobile-nav-add" onclick="handleMobileAdd()" class="flex flex-col items-center justify-center -mt-8 bg-swc-primary w-14 h-14 rounded-full shadow-lg border-4 border-gray-100 text-white hover:scale-105 transition"><i class="ph ph-plus text-2xl font-bold"></i></button>
        <button id="mobile-nav-rotom" onclick="navigateTo('rotom')" class="flex flex-col items-center gap-1 text-slate-300 hover:text-white transition"><i class="ph ph-check-square-offset text-2xl"></i><span class="text-[10px] font-bold">Tarefas</span></button>
        <button id="mobile-nav-menu" onclick="document.getElementById('mobile-menu-drawer').classList.toggle('hidden')" class="flex flex-col items-center gap-1 text-slate-300 hover:text-white transition"><i class="ph ph-list text-2xl"></i><span class="text-[10px] font-bold">Menu</span></button>
    </nav>

    <div id="mobile-menu-drawer" class="hidden fixed inset-0 z-50 bg-black/80 flex justify-end" onclick="this.classList.add('hidden')">
        <div class="w-64 h-full bg-swc-sidebar text-white p-6 shadow-xl" onclick="event.stopPropagation()">
            <h4 class="font-display font-bold text-xl mb-6 border-b border-white/20 pb-4">Menu Completo</h4>
            <div class="space-y-4">
                <button id="drawer-status" onclick="navigateTo('status'); document.getElementById('mobile-menu-drawer').classList.add('hidden')" class="w-full text-left py-2 flex items-center gap-3 text-swc-secondary"><i class="ph ph-monitor-play text-xl"></i> Status Produção</button>
                <button id="drawer-finished" onclick="navigateTo('finished'); document.getElementById('mobile-menu-drawer').classList.add('hidden')" class="w-full text-left py-2 flex items-center gap-3 text-sem-success"><i class="ph ph-package text-xl"></i> Finalizados</button>
                <button id="drawer-team" onclick="navigateTo('team'); document.getElementById('mobile-menu-drawer').classList.add('hidden')" class="w-full text-left py-2 flex items-center gap-3"><i class="ph ph-users text-xl"></i> Equipe</button>
                <button id="drawer-tm" onclick="navigateTo('tm'); document.getElementById('mobile-menu-drawer').classList.add('hidden')" class="w-full text-left py-2 flex items-center gap-3"><i class="ph ph-book-bookmark text-xl"></i> Manuais</button>
                <button id="drawer-settings" onclick="navigateTo('settings'); document.getElementById('mobile-menu-drawer').classList.add('hidden')" class="w-full text-left py-2 flex items-center gap-3"><i class="ph ph-sliders text-xl"></i> Configurações</button>
                <button id="drawer-logs" onclick="navigateTo('logs'); document.getElementById('mobile-menu-drawer').classList.add('hidden')" class="w-full text-left py-2 flex items-center gap-3 text-red-300"><i class="ph ph-bug text-xl"></i> Logs</button>
                <button onclick="logout()" class="w-full text-left py-2 flex items-center gap-3 text-red-400 border-t border-white/10 mt-4 pt-4"><i class="ph ph-sign-out text-xl"></i> Sair</button>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-0 md:p-4">
        <div id="modal-content" class="bg-white rounded-none md:rounded-2xl shadow-2xl w-full md:max-w-5xl h-full md:max-h-[90vh] flex flex-col relative overflow-hidden"></div>
    </div>

    <template id="tpl-server">
        <div class="flex flex-col h-full bg-gray-50 relative">
            <div class="px-4 md:px-8 py-5 border-b border-gray-200 bg-white sticky top-0 z-20 shadow-sm flex justify-between items-center">
                <h3 class="text-xl font-display font-bold text-slate-800 flex items-center gap-2"><i class="ph ph-hard-drives text-swc-primary"></i> <span id="modal-title">Ficha</span></h3>
                <button type="button" onclick="closeModal()" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-400 hover:text-sem-error transition-colors"><i class="ph ph-x text-lg"></i></button>
            </div>
            <div class="p-4 md:p-8 overflow-y-auto custom-scrollbar flex-1 pb-24">
                <form id="form-generic" class="space-y-8">
                    <input type="hidden" id="item-id">
                    
                    <div class="bg-swc-sidebar p-5 rounded-xl text-white shadow-md flex flex-col md:flex-row items-center justify-between border border-slate-700 gap-4">
                        <div class="w-full md:w-auto">
                            <label class="text-[10px] font-bold text-swc-primary uppercase tracking-wider block mb-1.5">Status Atual</label>
                            <select id="inp-status" class="bg-slate-900 border border-slate-600 text-white text-sm rounded-lg p-2.5 w-full md:w-72 font-semibold focus:ring-2 focus:ring-swc-primary outline-none cursor-pointer transition-all hover:border-slate-500" onchange="updateServerFormState()"><option>Carregando...</option></select>
                        </div>
                        <i class="ph ph-conveyor-belt text-4xl text-slate-600 opacity-50 hidden md:block"></i>
                    </div>

                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-5 flex items-center gap-2"><i class="ph ph-tag text-lg"></i> Identificação</h4>
                        <div class="mb-5 field-wrapper" id="wrapper-client">
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 flex items-center gap-1">Cliente</label>
                            <input type="text" id="inp-client" class="w-full border border-gray-300 rounded-lg p-3 outline-none focus:border-swc-secondary focus:ring-1 focus:ring-swc-secondary transition-all" placeholder="Nome do Cliente">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="field-wrapper" id="wrapper-product"><label class="block text-xs font-bold text-slate-500 mb-1.5 flex items-center gap-1">Produto</label><select id="inp-product" class="w-full border border-gray-300 rounded-lg p-3 bg-white outline-none focus:border-swc-secondary transition-all"></select></div>
                            <div class="field-wrapper" id="wrapper-purpose"><label class="block text-xs font-bold text-slate-500 mb-1.5 flex items-center gap-1">Finalidade</label><select id="inp-purpose" class="w-full border border-gray-300 rounded-lg p-3 bg-white outline-none focus:border-swc-secondary transition-all" onchange="updateWorkflowFromPurpose(this.value)"></select></div>
                        </div>
                    </div>

                    <div id="section-hardware" class="step-content bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-5 flex items-center gap-2"><i class="ph ph-cpu text-lg"></i> Plataforma</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-5">
                            <div class="field-wrapper" id="wrapper-vendor"><label class="block text-xs font-bold text-slate-500 mb-1.5">Fabricante</label><select id="inp-vendor" class="w-full border border-gray-300 rounded-lg p-3 bg-white outline-none focus:border-swc-secondary"></select></div>
                            <div class="col-span-1 md:col-span-2 field-wrapper" id="wrapper-model"><label class="block text-xs font-bold text-slate-500 mb-1.5">Modelo</label><input type="text" id="inp-model" class="w-full border border-gray-300 rounded-lg p-3 outline-none focus:border-swc-secondary"></div>
                            <div class="field-wrapper" id="wrapper-serial"><label class="block text-xs font-bold text-slate-500 mb-1.5">Serial (Tag)</label><input type="text" id="inp-serial" class="w-full border border-gray-300 rounded-lg p-3 outline-none focus:border-swc-secondary"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="field-wrapper" id="wrapper-cpu"><label class="block text-xs font-bold text-slate-500 mb-1.5">Processador</label><input type="text" id="inp-cpu" class="w-full border border-gray-300 rounded-lg p-3 outline-none focus:border-swc-secondary"></div>
                            <div class="field-wrapper" id="wrapper-os"><label class="block text-xs font-bold text-slate-500 mb-1.5">Sistema Operacional</label><select id="inp-os" class="w-full border border-gray-300 rounded-lg p-3 bg-white outline-none focus:border-swc-secondary"></select></div>
                        </div>
                    </div>

                    <div id="section-assembly" class="step-content bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-5 flex items-center gap-2"><i class="ph ph-wrench text-lg"></i> Componentes</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="field-wrapper" id="wrapper-disks"><div class="flex justify-between items-center mb-3"><label class="text-xs font-bold text-slate-500">DISCOS</label><button type="button" onclick="addDisk()" class="text-[10px] bg-swc-sidebar text-white px-2 py-1 rounded hover:bg-black transition">+ Add</button></div><div id="disks-container" class="space-y-3"></div></div>
                            <div class="field-wrapper" id="wrapper-cards"><div class="flex justify-between items-center mb-3"><label class="text-xs font-bold text-slate-500">PLACAS</label><button type="button" onclick="addCard()" class="text-[10px] bg-swc-sidebar text-white px-2 py-1 rounded hover:bg-black transition">+ Add</button></div><div id="cards-container" class="space-y-3"></div></div>
                            <div class="field-wrapper" id="wrapper-ram"><div class="flex justify-between items-center mb-3"><label class="text-xs font-bold text-slate-500">RAM</label><button type="button" onclick="addRam()" class="text-[10px] bg-swc-sidebar text-white px-2 py-1 rounded hover:bg-black transition">+ Add</button></div><div id="ram-container" class="space-y-3"></div></div>
                        </div>
                    </div>

                    <div id="section-config" class="step-content bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-5 flex items-center gap-2"><i class="ph ph-terminal-window text-lg"></i> Rede</h4>
                        <div class="field-wrapper" id="wrapper-hostname"><label class="block text-xs font-bold text-slate-500 mb-1.5">Hostname</label><input type="text" id="inp-hostname" class="w-full border border-swc-secondary/50 bg-swc-secondary/5 text-swc-secondary font-bold font-mono rounded-lg p-3 outline-none focus:ring-1 focus:ring-swc-secondary"></div>
                    </div>

                    <div id="section-qa" class="step-content bg-white p-6 rounded-xl border border-slate-200 shadow-sm field-wrapper">
                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-5 flex items-center gap-2"><i class="ph ph-clipboard-text text-lg"></i> Controle de Qualidade</h4>
                        <div class="mb-6 field-wrapper" id="wrapper-qa_ip"><label class="block text-xs font-bold text-slate-500 mb-1.5">IP de Manutenção</label><input type="text" id="inp-qa_ip" class="w-full border border-gray-300 rounded-lg p-3 outline-none font-mono text-sm focus:border-swc-secondary" placeholder="Ex: 192.168.100.50"></div>
                        <div class="field-wrapper mb-6" id="wrapper-qa_checklist">
                            <label class="block text-xs font-bold text-slate-500 mb-3">Validações Obrigatórias</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="flex items-center gap-3 p-4 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-gray-300 transition select-none group"><input type="checkbox" id="inp-qa_func" class="w-5 h-5 text-swc-primary rounded focus:ring-swc-primary border-gray-300"><span class="text-sm font-medium text-slate-700 group-hover:text-slate-900">Teste Funcionalidade</span></label>
                                <label class="flex items-center gap-3 p-4 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-gray-300 transition select-none group"><input type="checkbox" id="inp-qa_rails" class="w-5 h-5 text-swc-primary rounded focus:ring-swc-primary border-gray-300"><span class="text-sm font-medium text-slate-700 group-hover:text-slate-900">Trilhos do Servidor</span></label>
                                <label class="flex items-center gap-3 p-4 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-gray-300 transition select-none group"><input type="checkbox" id="inp-qa_cables" class="w-5 h-5 text-swc-primary rounded focus:ring-swc-primary border-gray-300"><span class="text-sm font-medium text-slate-700 group-hover:text-slate-900">Organização Cabos</span></label>
                                <label class="flex items-center gap-3 p-4 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-gray-300 transition select-none group"><input type="checkbox" id="inp-qa_stickers" class="w-5 h-5 text-swc-primary rounded focus:ring-swc-primary border-gray-300"><span class="text-sm font-medium text-slate-700 group-hover:text-slate-900">Adesivos/Etiquetas</span></label>
                                <label class="flex items-center gap-3 p-4 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-gray-300 transition select-none group col-span-1 md:col-span-2"><input type="checkbox" id="inp-qa_db" class="w-5 h-5 text-swc-primary rounded focus:ring-swc-primary border-gray-300"><span class="text-sm font-medium text-slate-700 group-hover:text-slate-900">Validação DB / CFG</span></label>
                            </div>
                        </div>
                        <div class="mt-4" id="wrapper-qa_details"><label class="block text-xs font-bold text-slate-500 mb-1.5">Observações Detalhadas de Teste</label><textarea id="inp-qa_details" rows="4" class="w-full border border-gray-300 rounded-lg p-3 outline-none focus:border-swc-primary text-sm" placeholder="Descreva o problema constatado"></textarea></div>
                    </div>

                    <div id="section-photos" class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mt-6">
                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-5 flex items-center gap-2"><i class="ph ph-camera text-lg"></i> Registro Fotográfico</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><div class="flex justify-between items-center mb-2"><label class="block text-xs font-bold text-slate-500">Fotos do Servidor</label><div class="flex gap-2"><button type="button" onclick="document.getElementById('upload-server').click()" class="text-[10px] bg-gray-100 text-slate-600 px-3 py-1.5 rounded hover:bg-gray-200 transition flex items-center gap-1"><i class="ph ph-upload-simple"></i> Upload</button><button type="button" onclick="startCamera('server')" class="text-[10px] bg-swc-secondary text-white px-3 py-1.5 rounded hover:brightness-110 transition flex items-center gap-1 font-bold shadow-sm"><i class="ph ph-camera"></i> Câmera</button></div></div><input type="file" id="upload-server" class="hidden" multiple accept="image/*" onchange="processFiles(this, 'server')"><div id="gallery-server" class="grid grid-cols-3 gap-2"></div></div>
                            <div><div class="flex justify-between items-center mb-2"><label class="block text-xs font-bold text-slate-500">Fotos da Caixa</label><div class="flex gap-2"><button type="button" onclick="document.getElementById('upload-box').click()" class="text-[10px] bg-gray-100 text-slate-600 px-3 py-1.5 rounded hover:bg-gray-200 transition flex items-center gap-1"><i class="ph ph-upload-simple"></i> Upload</button><button type="button" onclick="startCamera('box')" class="text-[10px] bg-swc-secondary text-white px-3 py-1.5 rounded hover:brightness-110 transition flex items-center gap-1 font-bold shadow-sm"><i class="ph ph-camera"></i> Câmera</button></div></div><input type="file" id="upload-box" class="hidden" multiple accept="image/*" onchange="processFiles(this, 'box')"><div id="gallery-box" class="grid grid-cols-3 gap-2"></div></div>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row items-center gap-3 pt-6 mt-8 border-t border-gray-200 sticky bottom-0 bg-gray-50 pb-2 z-20">
                        <div class="flex w-full md:w-auto gap-2">
                            <button type="button" onclick="deleteItem('servers')" id="btn-delete" class="flex-1 md:flex-none px-5 py-2.5 text-sem-error border border-sem-error/30 bg-white rounded-xl hover:bg-sem-error/10 transition font-medium hidden">Excluir</button>
                            <button type="button" onclick="closeModal()" class="flex-1 md:flex-none px-6 py-3 text-slate-500 hover:bg-gray-200 rounded-xl font-medium transition">Cancelar</button>
                        </div>
                        <div class="flex-1"></div>
                        <div class="grid grid-cols-2 md:flex gap-2 w-full md:w-auto">
                            <button type="button" onclick="sendManualEmail(event, document.getElementById('item-id').value)" class="px-3 py-3 text-slate-600 border border-gray-300 hover:bg-gray-100 rounded-xl font-medium transition flex items-center justify-center gap-2" title="Enviar Email"><i class="ph ph-envelope-simple text-lg"></i></button>
                            <button type="button" onclick="downloadReportNow(event)" class="px-6 py-3 text-swc-secondary border border-swc-secondary/30 hover:bg-swc-secondary/10 rounded-xl font-medium transition flex items-center gap-2"><i class="ph ph-file-pdf"></i> Relatório</button>
                            <button type="submit" class="col-span-2 md:col-span-1 px-8 py-3 bg-swc-sidebar text-white rounded-xl font-bold shadow-lg hover:bg-black hover:shadow-xl transition transform hover:-translate-y-0.5">Salvar</button>
                        </div>
                    </div>
                </form>

                <div id="history-section" class="mt-8 pt-8 border-t border-gray-200 hidden">
                    <h4 class="font-bold text-gray-800 text-sm mb-4 font-display">Histórico</h4>
                    <div id="history-list" class="space-y-0 relative border-l-2 border-gray-200 ml-3 pl-5 pb-2"></div>
                </div>
            </div>
        </div>
    </template>

    <template id="tpl-team">
        <div class="flex flex-col flex-1 min-h-0 overflow-hidden rounded-none md:rounded-2xl h-full">
            <div class="p-8 overflow-y-auto flex-1 custom-scrollbar">
                <div class="flex justify-between mb-6"><h3 class="text-xl font-bold font-display"><span id="modal-title">Usuário</span></h3><button type="button" onclick="closeModal()" class="text-gray-400"><i class="ph ph-x text-xl"></i></button></div>
                <form id="form-generic" class="space-y-4">
                    <input type="hidden" id="item-id">
                    <input type="text" id="inp-name" class="w-full border p-3 rounded-lg" placeholder="Nome" required>
                    <div class="grid grid-cols-2 gap-4">
                        <select id="inp-role" class="border p-3 rounded-lg bg-white" required>
                            <option value="">Selecione o Perfil...</option>
                            <option value="Admin">Admin (Acesso Total)</option>
                            <option value="T.I">T.I (Acesso Total)</option>
                            <option value="Comercial">Comercial (Apenas Solicitações)</option>
                            <option value="Financeiro">Financeiro (Apenas Solicitações)</option>
                        </select>
                        <input type="text" id="inp-initials" class="border p-3 rounded-lg" placeholder="Sigla" required maxlength="2">
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 space-y-3">
                        <h4 class="text-xs font-bold text-slate-500">Acesso</h4>
                        <input type="text" id="inp-email" class="w-full border p-3 rounded-lg" placeholder="Login" required>
                        <input type="password" id="inp-password" class="w-full border p-3 rounded-lg" placeholder="Senha" required>
                    </div>
                    <div class="flex gap-2 pt-4"><button type="button" onclick="deleteItem('users')" id="btn-delete" class="px-4 py-2 text-sem-error hidden">Excluir</button><button type="submit" class="flex-1 bg-swc-sidebar text-white py-3 rounded-lg font-bold">Salvar</button></div>
                </form>
            </div>
        </div>
    </template>

    <template id="tpl-manual">
        <div class="flex flex-col flex-1 min-h-0 overflow-hidden rounded-none md:rounded-2xl h-full">
            <div class="p-8 overflow-y-auto flex-1 custom-scrollbar">
                <div class="flex justify-between mb-6"><h3 class="text-xl font-bold font-display"><span id="modal-title">Manual</span></h3><button type="button" onclick="closeModal()" class="text-gray-400"><i class="ph ph-x text-xl"></i></button></div>
                <form id="form-generic" class="space-y-4">
                    <input type="hidden" id="item-id">
                    <input type="text" id="inp-title" class="w-full border p-3 rounded-lg" required>
                    <select id="inp-category" class="w-full border p-3 rounded-lg"></select>
                    <textarea id="inp-content" rows="8" class="w-full border p-3 rounded-lg font-mono text-sm" required></textarea>
                    <div class="flex gap-2 pt-4"><button type="button" onclick="deleteItem('manuals')" id="btn-delete" class="px-4 py-2 text-sem-error hidden">Excluir</button><button type="submit" class="flex-1 bg-swc-sidebar text-white py-3 rounded-lg font-bold">Salvar</button></div>
                </form>
            </div>
        </div>
    </template>

    <template id="tpl-task">
        <div class="flex flex-col flex-1 min-h-0 overflow-hidden rounded-none md:rounded-2xl h-full">
            <div class="p-4 md:p-8 overflow-y-auto flex-1 custom-scrollbar pb-20 md:pb-8">
                <div class="flex justify-between mb-6"><h3 class="text-xl font-bold font-display"><span id="modal-title">Nova Tarefa</span></h3><button type="button" onclick="closeModal()" class="text-gray-400"><i class="ph ph-x text-xl"></i></button></div>
                <form id="form-generic" class="space-y-4">
                    <input type="hidden" id="item-id">
                    <input type="text" id="inp-title" class="w-full border p-3 rounded-lg" placeholder="Título da Tarefa" required>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">Data de Execução</label><input type="date" id="inp-dueDate" class="w-full border p-3 rounded-lg" required></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">Responsáveis</label><div id="assignedTo-checkbox-container" class="border p-3 rounded-lg bg-white grid grid-cols-1 md:grid-cols-2 gap-2 max-h-40 overflow-y-auto custom-scrollbar"></div></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">Observações</label><textarea id="inp-notes" rows="3" class="w-full border p-3 rounded-lg text-sm" placeholder="Observações e informações complementares (opcional)"></textarea></div>
                    <hr class="border-gray-100 my-2">
                    <div class="flex justify-between items-center mb-2"><h4 class="font-bold text-sm text-slate-700">Checklist</h4><button type="button" onclick="addStep()" class="text-xs bg-swc-sidebar text-white px-3 py-1.5 rounded hover:bg-black transition">+ Item</button></div>
                    <div id="steps-container" class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar p-1"></div>
                    <div class="flex gap-2 pt-4 mt-4"><button type="button" onclick="deleteItem('tasks')" id="btn-delete" class="px-6 py-3 text-sem-error border border-sem-error/30 bg-white rounded-xl hover:bg-sem-error/10 transition font-medium hidden">Excluir</button><div class="flex-1"></div><button type="button" onclick="closeModal()" class="px-6 py-3 text-slate-500 hover:bg-gray-100 rounded-lg font-bold transition">Cancelar</button><button type="submit" class="flex-1 bg-swc-sidebar text-white py-3 rounded-lg font-bold hover:bg-black transition shadow-lg">Salvar Tarefa</button></div>
                </form>
            </div>
        </div>
    </template>

    <template id="tpl-rotine">
        <div class="flex flex-col flex-1 min-h-0 overflow-hidden rounded-none md:rounded-2xl h-full">
            <div class="p-8 overflow-y-auto flex-1 custom-scrollbar">
                <div class="flex justify-between mb-6"><h3 class="text-xl font-bold font-display"><span id="modal-title">Rotina</span></h3><button type="button" onclick="closeModal()" class="text-gray-400"><i class="ph ph-x text-xl"></i></button></div>
                <form id="form-generic" class="space-y-4">
                    <input type="hidden" id="item-id">
                    <input type="text" id="inp-title" class="w-full border p-3 rounded-lg" required>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><select id="inp-frequency" class="border p-3 rounded-lg"><option value="Diária">Diária</option><option value="Semanal">Semanal</option><option value="Quinzenal">Quinzenal</option><option value="Mensal">Mensal</option></select><div id="assignedTo-checkbox-container" class="border p-3 rounded-lg bg-white grid grid-cols-1 gap-2 max-h-40 overflow-y-auto custom-scrollbar"></div></div>
                    <hr>
                    <div class="flex justify-between"><h4 class="font-bold">Subtarefas</h4><button type="button" onclick="addStep()" class="text-xs bg-swc-sidebar text-white px-2 py-1 rounded">+ Add</button></div>
                    <div id="steps-container" class="space-y-2 max-h-48 overflow-y-auto"></div>
                    <div class="flex gap-2 pt-4"><button type="button" onclick="deleteItem('rotines')" id="btn-delete" class="px-4 py-2 text-sem-error hidden">Excluir</button><button type="submit" class="flex-1 bg-swc-sidebar text-white py-3 rounded-lg font-bold">Salvar</button></div>
                </form>
            </div>
        </div>
    </template>

    <template id="tpl-order">
        <div class="flex flex-col flex-1 min-h-0 overflow-hidden rounded-none md:rounded-2xl h-full">
            <div class="p-4 md:p-8 overflow-y-auto flex-1 custom-scrollbar">
                <div class="flex justify-between mb-6 border-b border-gray-100 pb-4">
                    <h3 class="text-xl font-bold font-display text-slate-800 flex items-center gap-2"><i class="ph ph-file-text text-swc-primary"></i> <span id="modal-title">Solicitação</span></h3>
                    <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-sem-error transition"><i class="ph ph-x text-xl"></i></button>
                </div>
                
                <form id="form-generic" class="space-y-6 pb-10">
                    <input type="hidden" id="item-id">
                    
                    <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-4 flex items-center gap-2"><i class="ph ph-user-circle text-lg"></i> Dados do Cliente</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="inp-clientName" class="w-full border border-gray-300 p-3 rounded-lg outline-none focus:border-swc-secondary" placeholder="Razão Social / Nome do Cliente *" required>
                            <div class="flex gap-4">
                                <input type="text" id="inp-clientCnpj" class="w-1/2 border border-gray-300 p-3 rounded-lg outline-none focus:border-swc-secondary" placeholder="CNPJ / CPF *" required>
                                <input type="text" id="inp-clientIE" class="w-1/2 border border-gray-300 p-3 rounded-lg outline-none focus:border-swc-secondary" placeholder="Insc. Estadual (Opcional)">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="text" id="inp-clientContact" class="w-full border border-gray-300 p-3 rounded-lg outline-none focus:border-swc-secondary" placeholder="Contato (A/C) *" required>
                                <input type="text" id="inp-clientPhone" class="w-full border border-gray-300 p-3 rounded-lg outline-none focus:border-swc-secondary" placeholder="Telefone / Celular *" required>
                            </div>
                            <input type="email" id="inp-clientEmail" class="w-full border border-gray-300 p-3 rounded-lg outline-none focus:border-swc-secondary" placeholder="E-mail do Cliente *" required>
                        </div>

                        <h4 class="text-xs font-bold text-slate-500 uppercase mt-6 mb-4 flex items-center gap-2"><i class="ph ph-map-pin text-lg"></i> Endereço de Entrega</h4>
                        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                            <div class="col-span-1 md:col-span-2 relative">
                                <input type="text" id="inp-clientCep" class="w-full border border-gray-300 p-3 rounded-lg outline-none focus:border-swc-secondary pr-10" placeholder="CEP *" onblur="buscarCEP(this.value)" maxlength="9" required>
                                <i class="ph ph-magnifying-glass absolute right-3 top-3.5 text-gray-400 text-lg pointer-events-none"></i>
                            </div>
                            <div class="col-span-1 md:col-span-4"><input type="text" id="inp-clientStreet" class="w-full border border-gray-300 p-3 rounded-lg outline-none focus:border-swc-secondary" placeholder="Rua / Avenida *" required></div>
                            <div class="col-span-1 md:col-span-2"><input type="text" id="inp-clientNumber" class="w-full border border-gray-300 p-3 rounded-lg outline-none focus:border-swc-secondary" placeholder="Número / Comp. *" required></div>
                            <div class="col-span-1 md:col-span-3"><input type="text" id="inp-clientCity" class="w-full border border-gray-300 p-3 rounded-lg outline-none focus:border-swc-secondary bg-gray-50" placeholder="Cidade *" readonly required></div>
                            <div class="col-span-1 md:col-span-1"><input type="text" id="inp-clientState" class="w-full border border-gray-300 p-3 rounded-lg outline-none focus:border-swc-secondary bg-gray-50 font-bold text-center" placeholder="UF *" readonly required></div>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-4 flex items-center gap-2"><i class="ph ph-package text-lg"></i> Equipamento & Serviços</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">Produto *</label><select id="inp-orderProduct" class="w-full border border-gray-300 p-3 rounded-lg bg-white outline-none focus:border-swc-secondary transition-all" required></select></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-2">Serviços Adicionais (Opcionais)</label><div id="additional-services-container" class="grid grid-cols-2 gap-2 bg-white p-3 rounded-lg border border-gray-300 max-h-32 overflow-y-auto custom-scrollbar"></div></div>
                        </div>

                        <div><label class="block text-xs font-bold text-slate-500 mb-1">Observações Contratuais</label><textarea id="inp-productConfig" rows="2" class="w-full border border-gray-300 p-3 rounded-lg text-sm outline-none focus:border-swc-secondary" placeholder="Detalhes contratuais ou técnicos..."></textarea></div>
                    </div>

                    <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-4 flex items-center gap-2"><i class="ph ph-clipboard-text text-lg"></i> Detalhes do Pedido</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">Solicitante (Automático) *</label><input type="text" id="inp-requesterName" class="w-full border border-gray-200 p-3 rounded-lg outline-none bg-gray-100 text-slate-500 font-bold cursor-not-allowed" readonly required></div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">Tipo de Contrato *</label><select id="inp-contractType" class="w-full border border-gray-300 p-3 rounded-lg bg-white outline-none focus:border-swc-secondary cursor-pointer" required></select></div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Responsáveis (Notificações) *</label>
                                <div id="order-responsibles-container" class="w-full border border-gray-300 p-2.5 rounded-lg bg-white max-h-32 overflow-y-auto custom-scrollbar grid grid-cols-1 gap-1"></div>
                            </div>
                        </div>

                        <div class="col-span-1 md:col-span-3 pt-6 border-t border-gray-200 mt-2">
                            <div class="p-5 rounded-2xl border-2 border-dashed border-swc-secondary/40 bg-gradient-to-r from-swc-secondary/5 to-transparent hover:border-swc-secondary/60 transition-all">
                                <label class="block text-sm font-bold text-swc-sidebar mb-1 flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-swc-secondary/20 flex items-center justify-center text-swc-secondary"><i class="ph ph-link text-lg"></i></div>
                                    Vincular a um Servidor em Bancada
                                </label>
                                <p class="text-[10px] text-gray-500 mb-4 pl-10">Opcional. Utilize apenas se a T.I já iniciou a montagem deste equipamento a pedido da diretoria.</p>
                                <div class="pl-10 relative">
                                    <select id="inp-linkedServer" class="w-full border border-swc-secondary/30 p-3.5 rounded-xl bg-white outline-none focus:border-swc-secondary focus:ring-2 focus:ring-swc-secondary/20 cursor-pointer font-medium text-slate-700 appearance-none shadow-sm">
                                        <option value="">Nenhum (Novo fluxo: a T.I iniciará a montagem)</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-swc-secondary"><i class="ph ph-caret-down text-lg"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Observações Gerais</label>
                        <textarea id="inp-observations" rows="2" class="w-full border border-gray-300 p-3 rounded-lg outline-none focus:border-swc-secondary bg-white text-slate-600 mb-4" placeholder="Outras informações de entrega ou detalhes extras..."></textarea>
                    </div>

                    <div class="flex gap-3 pt-6 border-t border-gray-100">
                        <button type="button" onclick="deleteItem('orders')" id="btn-delete" class="px-5 py-3 text-sem-error border border-sem-error/20 bg-white rounded-xl hover:bg-sem-error/10 hidden transition font-bold">Excluir</button>
                        <div class="flex-1"></div>
                        <button type="button" onclick="closeModal()" class="px-6 py-3 text-slate-500 hover:bg-gray-100 rounded-xl font-bold transition">Cancelar</button>
                        <button type="submit" class="bg-swc-sidebar text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:bg-black transition transform hover:-translate-y-0.5">Salvar Solicitação</button>
                    </div>
                </form>
            </div>
        </div>
    </template>

    <script>
        const API = '/api';
        let cachedTMs=[], cachedUsers=[], currentUser=null, statusChart=null, teamChart=null, allServers=[], allTasks=[], allOrders=[], cachedOptions=[], cachedWorkflows=[];
        let currentPhotos = { server: [], box: [] };
        let notifications = [];
        window.logsInterval = null; window.notifInterval = null;

        // --- HELPERS SWEETALERT2 (Modais Bonitos) ---
        Swal.fire({ toast: false, showConfirmButton: false, timer: 10 }); 
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true, customClass: { popup: 'rounded-xl shadow-lg border border-gray-100', title: 'font-sans text-sm text-slate-700' } });
        function showToast(msg, type='success') { Toast.fire({ icon: type === 'info' ? 'info' : (type === 'error' ? 'error' : 'success'), title: msg }); }
        async function swcConfirm(title, text, confirmText = 'Sim', confirmColor = '#003E3F') { const res = await Swal.fire({ title, text, icon: 'warning', showCancelButton: true, confirmButtonColor: confirmColor, cancelButtonColor: '#94a3b8', confirmButtonText: confirmText, cancelButtonText: 'Cancelar', customClass: { popup: 'font-sans rounded-2xl', title: 'font-display text-slate-800' } }); return res.isConfirmed; }
        async function swcPrompt(title, text, placeholder = '') { const res = await Swal.fire({ title, text, input: 'text', inputPlaceholder: placeholder, showCancelButton: true, confirmButtonColor: '#003E3F', cancelButtonColor: '#94a3b8', confirmButtonText: 'Salvar', cancelButtonText: 'Cancelar', customClass: { popup: 'font-sans rounded-2xl', title: 'font-display text-slate-800' } }); return res.value; }
        async function swcAlert(title, text, icon = 'warning') { await Swal.fire({ title, text, icon, confirmButtonColor: '#003E3F', customClass: { popup: 'font-sans rounded-2xl', title: 'font-display text-slate-800' } }); }

        // --- SISTEMA DE NOTIFICAÇÕES (SININHO) ---
        async function fetchNotifications() {
            if (!currentUser) return;
            try {
                const res = await fetch(`${API}/notifications?email=${encodeURIComponent(currentUser.email)}&role=${encodeURIComponent(currentUser.role)}`);
                if (res.ok) { notifications = await res.json(); renderNotifications(); }
            } catch (e) { console.error(e); }
        }

        function renderNotifications() {
            const list = document.getElementById('notif-list'); const badge = document.getElementById('notif-badge');
            if(!list || !badge) return;
            const unread = notifications.filter(n => !n.readBy.includes(currentUser.email));
            
            if(unread.length > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden');
            if(notifications.length === 0) { list.innerHTML = '<div class="p-6 text-center text-slate-400 text-xs">Nenhuma notificação recente.</div>'; return; }

            list.innerHTML = notifications.map(n => {
                const isRead = n.readBy.includes(currentUser.email);
                return `<div class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition ${isRead ? 'opacity-60' : 'bg-swc-primary/5'}" onclick="handleNotifClick('${n.id}', '${n.link}')"><div class="flex gap-3 items-start"><div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ${isRead ? 'bg-gray-200 text-gray-500' : 'bg-swc-primary/20 text-swc-primary'}"><i class="ph ph-bell-ringing"></i></div><div><p class="text-xs font-bold text-slate-800 font-display">${n.title}</p><p class="text-[10px] text-slate-500 mt-0.5 leading-tight">${n.message}</p><p class="text-[9px] text-slate-400 mt-1">${new Date(n.createdAt).toLocaleDateString('pt-BR')} às ${new Date(n.createdAt).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</p></div></div></div>`;
            }).join('');
        }

        function toggleNotifications(e) { if(e) e.stopPropagation(); document.getElementById('notif-dropdown')?.classList.toggle('hidden'); }
        
        window.addEventListener('click', (e) => { const dd = document.getElementById('notif-dropdown'); if(dd && !dd.classList.contains('hidden') && !e.target.closest('#notif-dropdown') && !e.target.closest('button[onclick="toggleNotifications(event)"]')) { dd.classList.add('hidden'); } });

        async function handleNotifClick(id, link) {
            document.getElementById('notif-dropdown').classList.add('hidden');
            
            // Marca como lido silenciosamente
            try { await fetch(`${API}/notifications/${id}/read`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: currentUser.email }) }); fetchNotifications(); } catch (e) {}

            // Se a notificação tiver um link para um Servidor, abre o nosso Card novo!
            if (link) { 
                const parts = link.split('/'); 
                if (parts[0] === 'pokeball' && parts[1]) {
                    viewServerDetails(parts[1]);
                } else {
                    navigateTo(parts[0], parts[1]); 
                }
            }
        }
        
        async function markAllRead() {
            const unread = notifications.filter(n => !n.readBy.includes(currentUser.email));
            for(let n of unread) { await fetch(`${API}/notifications/${n.id}/read`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: currentUser.email }) }); }
            fetchNotifications();
        }

        // --- OUTRAS FUNÇÕES ---
        async function buscarCEP(cep) {
            const numCep = cep.replace(/\D/g, '');
            if (numCep.length === 8) {
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${numCep}/json/`); const data = await response.json();
                    if (!data.erro) { document.getElementById('inp-clientStreet').value = data.logradouro; document.getElementById('inp-clientCity').value = data.localidade; document.getElementById('inp-clientState').value = data.uf; document.getElementById('inp-clientNumber').focus(); } 
                    else showToast('CEP não encontrado.', 'error');
                } catch (error) { showToast('Erro ao buscar CEP.', 'error'); }
            }
        }

        async function fetchLogs() { try { const res = await fetch(`${API}/logs`); document.getElementById('logs-output').innerText = await res.text(); document.getElementById('logs-output').parentElement.scrollTop = document.getElementById('logs-output').parentElement.scrollHeight; } catch (e) { document.getElementById('logs-output').innerText = `ERRO: Não foi possível conectar ao endpoint de logs. (${e.message})`; } }        

        function getISODate() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }

        const FIELD_LABELS = { client: 'Cliente', product: 'Produto', purpose: 'Finalidade', vendor: 'Fabricante', model: 'Modelo', serial: 'Serial', cpu: 'Processador', os: 'SO', disks: 'Discos', cards: 'Placas', ram: 'RAM', hostname: 'Hostname', qa_ip: 'IP Manutenção', qa_checklist: 'Checklist QA', qa_details: 'Diagnóstico' };

        // --- FUNÇÕES DE CHECKLIST E TAREFAS ---
        function addStep(stepValue = '', manualValue = '') {
            const container = document.getElementById('steps-container'); if (!container) return;
            const div = document.createElement('div'); div.className = 'step-item flex gap-2 items-center bg-gray-50 p-2 rounded border border-gray-200';
            div.innerHTML = `<input type="text" placeholder="Nome da tarefa / etapa" value="${stepValue}" class="step-title flex-1 border p-1.5 text-xs rounded outline-none focus:border-swc-secondary"><input type="text" placeholder="Instrução/Manual (Opcional)" value="${manualValue}" class="step-manual flex-1 border p-1.5 text-xs rounded outline-none focus:border-swc-secondary"><button type="button" onclick="this.parentElement.remove()" class="text-sem-error hover:text-red-700" title="Remover"><i class="ph ph-trash"></i></button>`;
            container.appendChild(div);
        }

        async function toggleTaskStep(taskId, stepIdx, isCompleted) {
            const task = allTasks.find(t => t.id === taskId); if(!task) return; task.checklist[stepIdx].completed = isCompleted;
            try { await fetch(`${API}/tasks/${taskId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ checklist: task.checklist }) }); loadData('rotom'); } catch (e) { showToast('Erro ao atualizar checklist', 'error'); }
        }

        async function finishTask(taskId, btn) {
            btn.disabled = true; btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Concluindo...';
            try {
                await fetch(`${API}/tasks/${taskId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'Concluído' }) });
                const taskInfo = allTasks.find(t => t.id === taskId);
                await fetch(`${API}/notify`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: 'task', title: taskInfo.title, user: currentUser.name, date: getISODate(), frequency: taskInfo.frequency, checklist: taskInfo.checklist }) });
                showToast('Tarefa Concluída!', 'success'); loadData('rotom');
            } catch (e) { showToast('Erro ao concluir tarefa', 'error'); btn.disabled = false; }
        }

        // --- FUNÇÕES DE EXCLUSÃO E OPÇÕES ---
        async function deleteItem(collection) {
            const id = document.getElementById('item-id').value; if(!id) return;
            if (!(await swcConfirm('Confirmar exclusão?', 'Esta ação é irreversível e o item será apagado permanentemente.', 'Sim, excluir!', '#F6242A'))) return;
            try {
                if (collection === 'orders') {
                    const order = allOrders.find(o => o.id === id);
                    if (order) await fetch(`${API}/notify`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'order_canceled', orderId: order.id, client: order.client?.name || 'Cliente', product: order.product?.description || 'Produto', requester: currentUser.name, requesterEmail: currentUser.email, emails: order.notificationEmails }) });
                }
                await fetch(`${API}/${collection}/${id}`, { method: 'DELETE' }); showToast('Item excluído com sucesso!'); closeModal(); loadData(collection === 'users' ? 'team' : (collection === 'manuals' ? 'tm' : collection));
            } catch(e) { showToast('Erro ao excluir', 'error'); }
        }

        async function addOption(type) {
            const val = await swcPrompt('Novo Item', 'Digite o nome do novo valor a ser adicionado:'); if (!val || val.trim() === '') return;
            try { await fetch(`${API}/options`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: type, value: val }) }); showToast('Opção adicionada!'); loadData('settings'); } catch(e) { showToast('Erro ao adicionar', 'error'); }
        }

        async function deleteOption(id) {
            if (!(await swcConfirm('Remover opção?', 'Isso removerá esta opção das listas suspensas do sistema.', 'Remover', '#F6242A'))) return;
            try { await fetch(`${API}/options/${id}`, { method: 'DELETE' }); showToast('Opção removida!'); loadData('settings'); } catch(e) { showToast('Erro ao remover', 'error'); }
        }        

        async function viewServerDetails(id) {
            try {
                let s = allServers.find(x => x.id === id);
                if (!s) { const res = await fetch(`${API}/servers/${id}`); if (res.ok) s = await res.json(); else throw new Error('Not found'); }
                
                let o = allOrders.find(x => x.linkedServerId === id);
                if (!o) { const res = await fetch(`${API}/orders`); if (res.ok) { const ords = await res.json(); o = ords.find(x => x.linkedServerId === id); } }

                const clientName = s.client || o?.client?.name || 'Sem Cliente';
                const cnpj = o?.client?.cnpj || 'N/A';
                const isFinished = s.status === 'Concluído';
                const badgeColor = isFinished ? 'bg-sem-success/10 text-sem-success border-sem-success/20' : 'bg-swc-secondary/10 text-swc-secondary border-swc-secondary/20';

                // --- TRAVA DE SEGURANÇA: SÓ FINANCEIRO OU ADMIN PODEM SUBIR N.F ---
                const role = (currentUser.role || '').toLowerCase();
                const canAttachNF = role.includes('financeiro') || role.includes('admin');

                // --- DADOS EXTRAS DO CLIENTE ---
                let addr = {}; 
                try { addr = typeof o?.client?.address === 'string' ? JSON.parse(o.client.address) : o?.client?.address; } catch(e) { addr = { street: o?.client?.address }; } 
                if (!addr) addr = {};
                const fullAddress = `${addr.street || ''}, ${addr.number || 'S/N'} - ${addr.city || ''}/${addr.state || ''}`.replace(/^, /, '').trim();
                const contactEmail = o?.client?.contactEmail || '-';
                const contactName = o?.client?.contactName || '-';
                const contactPhone = o?.client?.contactPhone || '-';
                const ie = o?.client?.ie ? ` - IE: ${o.client.ie}` : '';

                let compHtml = '';
                if (s.disks?.length) compHtml += `<div><strong>Discos:</strong><br>` + s.disks.map(d=>`<span class="text-slate-500">- ${d.size} ${d.model} <span class="font-mono text-[10px]">(SN: ${d.serial||'-'})</span></span>`).join('<br>') + `</div>`;
                if (s.ram?.length) compHtml += `<div class="mt-2"><strong>RAM:</strong><br>` + s.ram.map(r=>`<span class="text-slate-500">- ${r.gb}GB ${r.model} <span class="font-mono text-[10px]">(SN: ${r.serial||'-'})</span></span>`).join('<br>') + `</div>`;
                if (s.cards?.length) compHtml += `<div class="mt-2"><strong>Placas:</strong><br>` + s.cards.map(c=>`<span class="text-slate-500">- ${c.type} ${c.model} <span class="font-mono text-[10px]">(SN: ${c.serial||'-'})</span></span>`).join('<br>') + `</div>`;

                let pkgHtml = '';
                if (s.packageInfo) {
                     const dDate = s.packageInfo.deliveryDate ? s.packageInfo.deliveryDate.split('-').reverse().join('/') : '-';
                     pkgHtml = `<div class="bg-sem-success/5 p-3 rounded-xl border border-sem-success/20 text-xs text-slate-700 mt-4">
                        <p class="font-bold text-sem-success mb-2 uppercase text-[10px]"><i class="ph ph-package"></i> Dados Logísticos e Faturamento</p>
                        <div class="flex justify-between border-b border-sem-success/10 pb-1 mb-1"><span>Modo de Entrega:</span> <strong>${s.packageInfo.deliveryMode || '-'}</strong></div>
                        <div class="flex justify-between border-b border-sem-success/10 pb-1 mb-1"><span>Previsão:</span> <strong>${dDate}</strong></div>
                        <div class="flex justify-between border-b border-sem-success/10 pb-1 mb-1"><span>Dimensões:</span> <strong>${s.packageInfo.length}x${s.packageInfo.width}x${s.packageInfo.depth} cm</strong></div>
                        <div class="flex justify-between"><span>Peso Bruto:</span> <strong>${s.packageInfo.weight} kg</strong></div>
                     </div>`;
                }

                // --- LÓGICA DO BOTÃO DA NOTA FISCAL DENTRO DO MODAL ---
                let nfHtml = '';
                if (o && o.nfNumber) {
                    nfHtml = `
                    <div class="mt-4 flex justify-between items-center bg-green-50 p-3 rounded-xl border border-green-100">
                        <span class="text-xs font-bold text-slate-700 flex items-center gap-1"><i class="ph ph-receipt text-sem-success text-lg"></i> N.F: ${o.nfNumber}</span>
                        <div class="flex gap-2">
                            ${canAttachNF ? `<button type="button" onclick="Swal.close(); setTimeout(() => attachNF('${o.id}'), 300)" class="text-[10px] bg-white border border-green-300 text-green-700 px-3 py-1.5 rounded-md hover:bg-green-100 transition shadow-sm font-bold flex items-center gap-1" title="Substituir N.F."><i class="ph ph-arrows-clockwise text-sm"></i> Substituir</button>` : ''}
                            <a href="${o.nfAttachment}" target="_blank" class="text-[10px] bg-sem-success text-white px-3 py-1.5 rounded-md hover:bg-green-600 transition shadow-sm font-bold flex items-center gap-1"><i class="ph ph-eye text-sm"></i> Ver N.F.</a>
                        </div>
                    </div>`;
                } else if (isFinished && o && canAttachNF) {
                    nfHtml = `
                    <div class="mt-4">
                        <button type="button" onclick="Swal.close(); setTimeout(() => attachNF('${o.id}'), 300)" class="w-full border border-dashed border-gray-300 text-gray-500 hover:text-swc-primary hover:border-swc-primary hover:bg-swc-primary/5 p-3 rounded-xl text-xs font-bold transition flex items-center justify-center gap-2"><i class="ph ph-upload-simple text-xl"></i> Anexar Nota Fiscal</button>
                    </div>`;
                } else if (isFinished && o && !canAttachNF) {
                    nfHtml = `<div class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-xl text-center text-xs text-gray-400 font-bold flex flex-col items-center gap-1"><i class="ph ph-hourglass-high text-xl"></i> Aguardando Financeiro anexar N.F.</div>`;
                }

                Swal.fire({
                    title: false,
                    html: `
                        <div class="text-left font-sans mt-2">
                            <div class="flex justify-between items-start mb-4 border-b border-gray-100 pb-4">
                                <div>
                                    <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded border ${badgeColor} mb-2 inline-flex items-center gap-1"><i class="ph ${isFinished ? 'ph-check-circle' : 'ph-gear animate-spin'}"></i> ${s.status}</span>
                                    <h3 class="text-xl font-bold font-display text-slate-800 leading-tight">${clientName}</h3>
                                    <p class="text-xs text-gray-500 font-mono bg-gray-100 inline-block px-1.5 rounded mt-1">${cnpj}${ie}</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-200 text-xs text-slate-600 mb-4 shadow-sm">
                                <p class="font-bold text-gray-500 mb-3 uppercase text-[10px]"><i class="ph ph-user-circle"></i> Dados do Cliente</p>
                                <div class="grid grid-cols-2 gap-y-2 gap-x-4">
                                    <div><span class="text-gray-400 block text-[10px] uppercase">Contato (A/C)</span> <strong>${contactName}</strong></div>
                                    <div><span class="text-gray-400 block text-[10px] uppercase">Telefone</span> <strong>${contactPhone}</strong></div>
                                    <div class="col-span-2"><span class="text-gray-400 block text-[10px] uppercase">E-mail</span> <strong>${contactEmail}</strong></div>
                                    <div class="col-span-2"><span class="text-gray-400 block text-[10px] uppercase">Endereço</span> <strong>${fullAddress !== ' - /' && fullAddress !== '- /' ? fullAddress : 'Não informado'}</strong></div>
                                    <div class="col-span-2 mt-1 pt-2 border-t border-gray-100"><span class="text-gray-400 block text-[10px] uppercase">Contrato / Finalidade</span> <strong>${s.purpose || o?.contractType || '-'}</strong></div>
                                </div>
                            </div>

                            <div class="bg-swc-sidebar/5 p-3 rounded-xl border border-swc-sidebar/10 text-xs text-slate-600 mb-4 shadow-sm">
                                <p class="font-bold text-swc-sidebar mb-3 uppercase text-[10px]"><i class="ph ph-hard-drives"></i> Identificação do Equipamento</p>
                                <div class="grid grid-cols-2 gap-y-2 gap-x-4">
                                    <div class="col-span-2"><span class="text-gray-400 block text-[10px] uppercase">Produto</span> <strong class="text-sm text-slate-700">${s.product || '-'}</strong></div>
                                    <div><span class="text-gray-400 block text-[10px] uppercase">Modelo</span> <strong>${s.vendor || ''} ${s.model || '-'}</strong></div>
                                    <div><span class="text-gray-400 block text-[10px] uppercase">S/N (Tag)</span> <strong class="font-mono text-swc-secondary">${s.serial || '-'}</strong></div>
                                    <div><span class="text-gray-400 block text-[10px] uppercase">Hostname</span> <strong class="font-mono">${s.hostname || '-'}</strong></div>
                                    <div><span class="text-gray-400 block text-[10px] uppercase">IP Manutenção</span> <strong class="font-mono">${s.qa_ip || '-'}</strong></div>
                                </div>
                                <div class="mt-3 text-xs text-slate-700 border-t border-swc-sidebar/10 pt-2">${compHtml ? compHtml : '<span class="italic text-gray-400">Sem discos ou placas registrados.</span>'}</div>
                            </div>
                            
                            ${s.qa_details ? `<div class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-xs text-slate-600 mt-4"><p class="font-bold text-gray-500 mb-1 uppercase text-[10px]"><i class="ph ph-info"></i> Observações Técnicas</p><p>${s.qa_details}</p></div>` : ''}
                            ${pkgHtml}
                            ${nfHtml}
                            
                            <div class="text-[10px] text-gray-400 mt-4 pt-3 border-t border-gray-100 text-center">Técnico Responsável: ${s.userAction || 'T.I'}</div>
                        </div>
                    `,
                    showCloseButton: true,
                    showConfirmButton: isFinished,
                    confirmButtonText: '<i class="ph ph-file-pdf text-lg mr-1"></i> Baixar Laudo',
                    confirmButtonColor: '#34B0B1',
                    customClass: { popup: 'font-sans rounded-3xl shadow-2xl w-full max-w-md', htmlContainer: 'p-0 m-0' }
                }).then((result) => {
                    if (result.isConfirmed && isFinished) {
                        downloadReportNow({stopPropagation: ()=>{}}, s.id);
                    }
                });
            } catch(e) {
                showToast('Erro ao carregar detalhes.', 'error');
            }
        }   

        async function updateOrdersBadge() {
            try {
                const res = await fetch(`${API}/orders`);
                if(res.ok) {
                    const ordersList = await res.json();
                    const pendingCount = ordersList.filter(o => o.status === 'Pendente').length;
                    
                    const badgeDesktop = document.getElementById('badge-orders-desktop');
                    const badgeMobile = document.getElementById('badge-orders-mobile');
                    
                    if(pendingCount > 0) {
                        if(badgeDesktop) { badgeDesktop.innerText = pendingCount; badgeDesktop.classList.remove('hidden'); }
                        if(badgeMobile) { badgeMobile.innerText = pendingCount; badgeMobile.classList.remove('hidden'); badgeMobile.classList.add('flex'); }
                    } else {
                        if(badgeDesktop) badgeDesktop.classList.add('hidden');
                        if(badgeMobile) { badgeMobile.classList.add('hidden'); badgeMobile.classList.remove('flex'); }
                    }
                }
            } catch (e) {}
        }

        function checkAuth() { 
            const s = localStorage.getItem('user_session'); 
            if(!s) { window.location.href = 'login.html'; } else { 
                currentUser = JSON.parse(s); 
                document.getElementById('app-body').classList.remove('hidden'); 
                document.getElementById('user-name').innerText = currentUser.name; 
                document.getElementById('user-role').innerText = currentUser.role; 
                document.getElementById('user-avatar').innerText = currentUser.initials; 
                if(currentUser.color) document.getElementById('user-avatar').className = `w-10 h-10 rounded-full flex items-center justify-center font-bold text-white ${currentUser.color}`; 
                
                const role = (currentUser.role || '').toLowerCase();
                const isFullAccess = role === 'admin' || role === 't.i' || role.includes('admin') || role.includes('t.i');
                
                if (!isFullAccess) {
                    const hideElements = ['nav-dashboard', 'label-nav-overview', 'nav-pokeball', 'nav-rotom', 'label-nav-production', 'nav-rotines', 'nav-tm', 'nav-team', 'nav-settings', 'label-nav-management', 'nav-logs', 'label-nav-diag', 'mobile-nav-dashboard', 'mobile-nav-rotom', 'drawer-team', 'drawer-tm', 'drawer-settings', 'drawer-logs'];
                    hideElements.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
                    const currentHash = window.location.hash.slice(1).split('/')[0] || 'dashboard';
                    if (currentHash !== 'orders' && currentHash !== 'status' && currentHash !== 'finished') window.location.hash = 'orders';
                }
                
                fetchNotifications();
                updateOrdersBadge(); // Chama a bolinha assim que abre a tela
                
                if(window.notifInterval) clearInterval(window.notifInterval);
                
                // Atualiza o sininho e a bolinha de vendas a cada 30 segundos silenciosamente
                window.notifInterval = setInterval(() => { 
                    fetchNotifications(); 
                    updateOrdersBadge(); 
                }, 30000);
            } 
        }

        function handleMobileAdd() { const role = (currentUser?.role || '').toLowerCase(); if (role === 'comercial' || role === 'financeiro') { openCreateModal('orders'); } else { openCreateModal('pokeball'); } }
        function logout() { localStorage.removeItem('user_session'); window.location.href='login.html'; }
        
        window.addEventListener('hashchange', handleHash);
        window.addEventListener('load', () => { checkAuth(); handleHash(); });

        async function openCreateModal(view) { renderModalForm(view, null); }
        async function openEditModal(view, id) {
            let endpoint = view === 'tm' ? 'manuals' : (view === 'pokeball' ? 'servers' : (view === 'team' ? 'users' : (view === 'rotom' ? 'tasks' : (view === 'orders' ? 'orders' : 'rotines'))));
            try { const res = await fetch(`${API}/${endpoint}/${id}`); if(res.ok) renderModalForm(view, await res.json()); else { showToast('Item não encontrado.', 'error'); navigateTo(view); } } catch (e) { navigateTo(view); }
        }

        async function handleHash() {
            const hash = window.location.hash.slice(1) || 'dashboard'; const [view, id] = hash.split('/');
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const activeView = document.getElementById(`view-${view}`); if(activeView) activeView.classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('bg-white/10','text-white', 'text-swc-secondary'); b.classList.add('text-slate-400'); });
            const btn = document.getElementById(`nav-${view}`); if(btn) { btn.classList.remove('text-slate-400'); btn.classList.add('bg-white/10', view === 'status' ? 'text-swc-secondary' : 'text-white'); }
            
            if(window.dashInterval) clearInterval(window.dashInterval);
            if (view !== 'logs' && window.logsInterval) { clearInterval(window.logsInterval); window.logsInterval = null; }          
            
            updateHeader(view); await loadData(view); 
            if(id) openEditModal(view, id); else closeModal(false);
        }

        function navigateTo(view, id = null) { window.location.hash = id ? `${view}/${id}` : view; }

        function updateHeader(view) {
            const titles = { dashboard: 'Visão Geral', rotom: 'Tarefas', rotines: 'Gerenciar Rotinas', pokeball: 'Servidores', tm: 'Manuais', team: 'Equipe', settings: 'Configurações', orders: 'Comercial', status: 'Painel de Status', finished: 'Finalizados a Expedição' };
            document.getElementById('header-left').innerHTML = `<h2 class="text-2xl font-display font-bold text-slate-800">${titles[view] || 'ShowCase Pro'}</h2>`;
            let btn = ''; if(view==='rotom') document.getElementById('header-left').innerHTML += `<input type="date" id="date-picker" class="ml-4 bg-transparent font-bold text-slate-500 font-display" onchange="loadData('rotom')">`;
            if(['rotines','pokeball','tm','team','rotom','orders'].includes(view)) btn = `<button onclick="openCreateModal('${view}')" class="hidden md:flex bg-swc-sidebar text-white px-5 py-2.5 rounded-lg font-bold shadow-lg hover:bg-black transition items-center gap-2"><i class="ph ph-plus"></i> Novo</button>`;
            document.getElementById('header-action').innerHTML = btn; if(view==='rotom') { const d=document.getElementById('date-picker'); if(d && !d.value) d.value = getISODate(); } 
        }

        function closeModal(c = true) {
            const modal = document.getElementById('modal'); const content = document.getElementById('modal-content'); if(!modal || !content) return;
            content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); if (c) history.pushState("", document.title, window.location.pathname + window.location.search + window.location.hash.split('/')[0]); }, 200);
        }

        async function loadData(view) {
            try {
                if(view === 'dashboard') { loadDashboardData(); window.dashInterval = setInterval(loadDashboardData, 30000); }
                else if(view === 'status') { const [srvRes, ordRes] = await Promise.all([fetch(`${API}/servers`), fetch(`${API}/orders`)]); allServers = await srvRes.json(); allOrders = await ordRes.json(); renderStatusPanel(); }
                else if(view === 'finished') { 
                    const [srvRes, ordRes] = await Promise.all([fetch(`${API}/servers`), fetch(`${API}/orders`)]); 
                    allServers = await srvRes.json(); allOrders = await ordRes.json(); 
                    renderFinishedPanel(); 
                }
                else if(view==='tm'){ const r=await fetch(`${API}/manuals`); cachedTMs=await r.json(); renderTMs(cachedTMs); }
                else if(view==='pokeball'){ const [srv, wf] = await Promise.all([fetch(`${API}/servers`).then(r=>r.json()), fetch(`${API}/workflows`).then(r=>r.json())]); allServers=srv; cachedWorkflows=wf; applyServerFilter(); }
                else if(view==='rotines'){ const r=await fetch(`${API}/rotines`); renderRotinesList(await r.json()); }
                else if(view==='rotom'){ if(window.taskLoadTimeout) clearTimeout(window.taskLoadTimeout); window.taskLoadTimeout = setTimeout(async () => { const d=document.getElementById('date-picker').value || getISODate(); const r=await fetch(`${API}/tasks?date=${d}`); allTasks=await r.json(); renderTasks(allTasks); }, 300); }
                else if(view==='team'){ const r=await fetch(`${API}/users`); cachedUsers=await r.json(); renderTeam(cachedUsers); }
                else if(view==='settings'){ const [opt, wf] = await Promise.all([fetch(`${API}/options`).then(r=>r.json()), fetch(`${API}/workflows`).then(r=>r.json())]); cachedOptions=opt; cachedWorkflows=wf; renderSettings(cachedOptions); renderWorkflowsSettings(cachedWorkflows); }
                else if(view === 'logs') { if (window.logsInterval) clearInterval(window.logsInterval); fetchLogs(); window.logsInterval = setInterval(fetchLogs, 2000); }
                else if(view === 'orders') { const r = await fetch(`${API}/orders`); allOrders = await r.json(); renderOrders(allOrders); }
            } catch(e){ console.error("Error loading data:", e); }
        }

        async function populateSelects() {
            try {
                if (cachedOptions.length === 0) { const res = await fetch(`${API}/options`); cachedOptions = await res.json(); }
                const fill = (id, type) => { const el = document.getElementById(id); if (el) { el.innerHTML = '<option value="">Selecione...</option>' + cachedOptions.filter(o => o.type === type).map(o => `<option value="${o.value}">${o.value}</option>`).join(''); } };
                fill('inp-product', 'product'); fill('inp-purpose', 'purpose'); fill('inp-vendor', 'vendor'); fill('inp-os', 'os'); fill('inp-category', 'tm_category'); fill('inp-orderProduct', 'product'); fill('inp-contractType', 'purpose');
            } catch(e) { console.error('Erro ao popular selects:', e); }
        }        
        
        async function loadDashboardData() {
            const today = getISODate();
            const [s, t, u] = await Promise.all([ fetch(`${API}/servers`).then(r=>r.json()), fetch(`${API}/tasks?date=${today}`).then(r=>r.json()), fetch(`${API}/users`).then(r=>r.json()) ]);
            const inProduction = s.filter(x => x.status !== 'Concluído').length; const pendingToday = t.filter(x => x.status !== 'Concluído').length; const doneToday = t.filter(x => x.status === 'Concluído').length;
            
            document.getElementById('dash-servers-count').innerText = inProduction; document.getElementById('dash-tasks-pending').innerText = pendingToday; document.getElementById('dash-tasks-done').innerText = doneToday; document.getElementById('dash-team-count').innerText = u.length;
            
            const filterVal = document.getElementById('dash-filter').value; let listItems = s.slice().reverse();
            if(filterVal === 'Produção') listItems = listItems.filter(s => s.status !== 'Concluído'); else if(filterVal === 'Concluído') listItems = listItems.filter(s => s.status === 'Concluído');
            document.getElementById('dash-server-list').innerHTML = listItems.slice(0, 5).map(i => `<div class="flex justify-between items-center border-b border-gray-100 pb-2 text-sm hover:bg-gray-50 p-2 rounded cursor-pointer" onclick="navigateTo('pokeball', '${i.id}')"><div class="flex gap-3 items-center"><div class="w-2 h-2 rounded-full ${i.status === 'Concluído' ? 'bg-sem-success' : 'bg-swc-secondary'}"></div><div><span class="block font-medium font-display">${i.product || 'Produto'} - ${i.client || 'Cliente'}</span><span class="text-xs text-gray-400 font-mono">${i.hostname || ''}</span></div></div><span class="font-bold text-xs ${i.status==='Concluído'?'text-sem-success bg-sem-success/10 px-2 py-0.5 rounded':'text-swc-secondary bg-swc-secondary/10 px-2 py-0.5 rounded'}">${i.status}</span></div>`).join('');
            
            const statusCounts = {}; s.forEach(x => statusCounts[x.status] = (statusCounts[x.status]||0)+1); const teamCounts = {}; t.forEach(x => teamCounts[Array.isArray(x.assignedTo) ? x.assignedTo[0] : x.assignedTo] = (teamCounts[Array.isArray(x.assignedTo) ? x.assignedTo[0] : x.assignedTo]||0)+1);
            if (document.getElementById('chartServers')) { if(statusChart) statusChart.destroy(); statusChart = new Chart(document.getElementById('chartServers'), { type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#85B433','#34B0B1','#003E3F','#CD6619','#A0B6D9'] }] }, options: { maintainAspectRatio: false, plugins:{legend:{position:'right', labels: { font: { family: 'Roboto' } }}} } }); }
            if (document.getElementById('chartTeam')) { if(teamChart) teamChart.destroy(); teamChart = new Chart(document.getElementById('chartTeam'), { type: 'bar', data: { labels: Object.keys(teamCounts), datasets: [{ label: 'Tarefas de Hoje', data: Object.values(teamCounts), backgroundColor: '#003E3F' }] }, options: { maintainAspectRatio: false, plugins:{legend:{display:false}}, scales: { x: { ticks: { font: { family: 'Roboto' } } } } } }); }
        }

        function toggleTVMode() { document.body.classList.toggle('tv-mode'); const isTv = document.body.classList.contains('tv-mode'); if(statusChart) { statusChart.options.plugins.legend.labels.color = isTv ? 'white' : '#666'; statusChart.update(); } if(teamChart) { teamChart.options.scales.x.ticks.color = isTv ? 'white' : '#666'; teamChart.options.scales.y.ticks.color = isTv ? 'white' : '#666'; teamChart.update(); } }
        function renderWorkflowsSettings(list) { const sel = document.getElementById('settings-workflow-select'); if(!sel) return; const purposes = cachedOptions.filter(o => o.type === 'purpose').map(o => o.value); sel.innerHTML = '<option value="">Selecione uma finalidade...</option>' + purposes.map(p => `<option value="${p}">${p}</option>`).join(''); }
        function renderSettings(list) { const types = { product: 'list-product', purpose: 'list-purpose', vendor: 'list-vendor', os: 'list-os', tm_category: 'list-tm_category', card_type: 'list-card_type', service: 'list-service' }; Object.values(types).forEach(id => { const el=document.getElementById(id); if(el) el.innerHTML = ''; }); list.forEach(item => { const ul = document.getElementById(types[item.type]); if(ul) ul.innerHTML += `<li class="flex justify-between items-center border-b border-gray-100 py-1"><span>${item.value}</span><button type="button" onclick="deleteOption('${item.id}')" class="text-sem-error hover:text-red-700 text-xs"><i class="ph ph-trash"></i></button></li>`; }); }

        async function loadWorkflowEditor(purpose) {
            if(!purpose) { document.getElementById('workflow-editor').classList.add('hidden'); return; }
            let wf = cachedWorkflows.find(w => w.purpose === purpose); const steps = wf ? wf.steps : [{name:'Solicitação', fields:['client'], required:['client']}];
            const list = document.getElementById('workflow-steps-list'); list.innerHTML = '';
            steps.forEach((step, idx) => {
                const allFields = ['client','product','purpose','vendor','model','serial','cpu','os','disks','cards','ram','hostname', 'qa_ip', 'qa_checklist', 'qa_details'];
                const fieldsHTML = allFields.map(f => `<div class="flex items-center mr-4 mb-1 bg-slate-100 px-2 py-1 rounded text-[10px]"><span class="w-16 text-gray-600 font-bold">${FIELD_LABELS[f] || f}</span><input type="checkbox" class="mr-1 cursor-pointer" title="Visível" ${step.fields && step.fields.includes(f) ? 'checked' : ''} onchange="updateStepField('${purpose}', ${idx}, '${f}', 'visible', this.checked)"><input type="checkbox" class="ml-2 cursor-pointer accent-sem-error" title="Obrigatório" ${step.required && step.required.includes(f) ? 'checked' : ''} onchange="updateStepField('${purpose}', ${idx}, '${f}', 'required', this.checked)"></div>`).join('');
                list.innerHTML += `<div class="bg-white p-3 rounded border border-gray-200 mb-2 shadow-sm"><div class="flex justify-between items-center mb-2"><span class="text-sm font-bold text-slate-700 font-display"><span class="text-gray-400 mr-2">${idx+1}.</span>${step.name}</span><button type="button" onclick="removeWorkflowStep('${purpose}', ${idx})" class="text-sem-error hover:text-red-700"><i class="ph ph-x-circle text-lg"></i></button></div><div class="flex flex-wrap gap-y-1">${fieldsHTML}</div></div>`;
            });
            document.getElementById('workflow-editor').classList.remove('hidden'); if(!wf) cachedWorkflows.push({ purpose, steps: [{name:'Solicitação', fields:['client'], required:['client']}] });
        }

        function updateStepField(purpose, stepIdx, field, type, isChecked) { let wf = cachedWorkflows.find(w => w.purpose === purpose); if(!wf) return; if(!wf.steps[stepIdx].fields) wf.steps[stepIdx].fields = []; if(!wf.steps[stepIdx].required) wf.steps[stepIdx].required = []; const arr = type === 'visible' ? wf.steps[stepIdx].fields : wf.steps[stepIdx].required; if(isChecked) { if(!arr.includes(field)) arr.push(field); if(type==='required' && !wf.steps[stepIdx].fields.includes(field)) { wf.steps[stepIdx].fields.push(field); loadWorkflowEditor(purpose); } } else { const idx = arr.indexOf(field); if(idx > -1) arr.splice(idx, 1); if(type==='visible') { const rI = wf.steps[stepIdx].required.indexOf(field); if(rI > -1) wf.steps[stepIdx].required.splice(rI, 1); loadWorkflowEditor(purpose); } } }
        async function addWorkflowStep() { const purpose = document.getElementById('settings-workflow-select').value; const input = document.getElementById('new-step-name'); if(!purpose || !input.value) return; let wf = cachedWorkflows.find(w => w.purpose === purpose); wf.steps.push({ name: input.value, fields: [], required: [] }); input.value = ''; loadWorkflowEditor(purpose); }
        async function removeWorkflowStep(purpose, idx) { let wf = cachedWorkflows.find(w => w.purpose === purpose); wf.steps.splice(idx, 1); loadWorkflowEditor(purpose); }
        async function saveCurrentWorkflow() { const purpose = document.getElementById('settings-workflow-select').value; if (!purpose) return showToast('Selecione uma finalidade primeiro', 'error'); const wf = cachedWorkflows.find(w => w.purpose === purpose); if (!wf) return showToast('Configuração não encontrada.', 'error'); try { const res = await fetch(`${API}/workflows/${encodeURIComponent(purpose)}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ steps: wf.steps }) }); const data = await res.json(); if (res.ok) { showToast(`Workflow salvo!`); const idx = cachedWorkflows.findIndex(w => w.purpose === purpose); if (idx !== -1) cachedWorkflows[idx] = data; else cachedWorkflows.push(data); } else throw new Error(data.error); } catch (e) { showToast(`Erro ao salvar: ${e.message}`, 'error'); } }

        function updateWorkflowFromPurpose(purpose, currentStatus) {
            if (!purpose) purpose = ''; let wf = cachedWorkflows.find(w => (w.purpose || '').toLowerCase() === purpose.toLowerCase());
            const steps = wf && wf.steps && wf.steps.length > 0 ? wf.steps : [{name: currentStatus || 'Início', fields:['client', 'product', 'purpose'], required:['client', 'product']}];
            const statusSelect = document.getElementById('inp-status');
            if(statusSelect) { statusSelect.innerHTML = steps.map(s => `<option value="${s.name}">${s.name}</option>`).join(''); const stepNames = steps.map(s=>s.name); if(currentStatus && stepNames.includes(currentStatus)) { statusSelect.value = currentStatus; } else { statusSelect.value = stepNames[0]; } updateServerFormState(statusSelect.value); }
        }

        function updateServerFormState(status) {
            if (!status) { const selectEl = document.getElementById('inp-status'); status = selectEl ? selectEl.value : 'Início'; } if (!status) return;
            const purpose = document.getElementById('inp-purpose').value; const wf = cachedWorkflows.find(w => (w.purpose || '').toLowerCase() === (purpose || '').toLowerCase());
            let currentStepObj = null; if (wf && wf.steps) { currentStepObj = wf.steps.find(s => s.name === status); }
            if(!currentStepObj) { currentStepObj = { fields: ['client', 'product', 'purpose', 'vendor', 'model', 'serial', 'cpu', 'os', 'disks', 'cards', 'ram', 'hostname', 'qa_ip', 'qa_checklist', 'qa_details'], required: [] }; }

            const visibleFields = currentStepObj.fields || []; const requiredFields = currentStepObj.required || []; const allWrappers = ['client','product','purpose','vendor','model','serial','cpu','os','disks','cards','ram','hostname', 'qa_ip', 'qa_checklist', 'qa_details']; const alwaysVisible = ['client', 'product', 'purpose'];

            allWrappers.forEach(field => { const wrapper = document.getElementById(`wrapper-${field}`); if(wrapper) { if(alwaysVisible.includes(field) || visibleFields.includes(field)) { wrapper.classList.remove('field-hidden'); wrapper.classList.add('active'); } else { wrapper.classList.add('field-hidden'); wrapper.classList.remove('active'); } if(requiredFields.includes(field)) wrapper.classList.add('field-required'); else wrapper.classList.remove('field-required'); } });
            const hw = document.getElementById('section-hardware'); const ass = document.getElementById('section-assembly'); const cfg = document.getElementById('section-config'); const qaSection = document.getElementById('section-qa'); 
            if(visibleFields.some(f => ['vendor','model','serial','cpu','os'].includes(f))) hw.classList.add('active'); else hw.classList.remove('active'); if(visibleFields.some(f => ['disks','cards','ram'].includes(f))) ass.classList.add('active'); else ass.classList.remove('active'); if(visibleFields.includes('hostname')) cfg.classList.add('active'); else cfg.classList.remove('active'); if(visibleFields.includes('qa_ip') || visibleFields.includes('qa_checklist') || visibleFields.includes('qa_details')) qaSection.classList.add('active'); else qaSection.classList.remove('active');
        }

        // --- FUNÇÕES DE HARDWARE ---
        function addDisk(size = '', model = '', serial = '') { const container = document.getElementById('disks-container'); if (!container) return; const div = document.createElement('div'); div.className = 'disk-item flex gap-2 items-center bg-slate-50 p-2 rounded border border-gray-200'; div.innerHTML = `<input type="text" placeholder="Tamanho (Ex: 1TB)" value="${size}" class="d-size w-1/3 border p-1.5 text-xs rounded outline-none focus:border-swc-secondary"><input type="text" placeholder="Modelo" value="${model}" class="d-model w-1/3 border p-1.5 text-xs rounded outline-none focus:border-swc-secondary"><input type="text" placeholder="Serial" value="${serial}" class="d-serial w-1/3 border p-1.5 text-xs rounded outline-none focus:border-swc-secondary"><button type="button" onclick="this.parentElement.remove()" class="text-sem-error hover:text-red-700" title="Remover"><i class="ph ph-trash"></i></button>`; container.appendChild(div); }
        function addCard(type = '', model = '', serial = '') { const container = document.getElementById('cards-container'); if (!container) return; let optionsHtml = '<option value="">Tipo...</option>'; if (typeof cachedOptions !== 'undefined') { const types = cachedOptions.filter(o => o.type === 'card_type'); optionsHtml += types.map(o => `<option value="${o.value}" ${type === o.value ? 'selected' : ''}>${o.value}</option>`).join(''); } if (type && !optionsHtml.includes(`value="${type}"`)) { optionsHtml += `<option value="${type}" selected>${type}</option>`; } const div = document.createElement('div'); div.className = 'card-item flex gap-2 items-center bg-slate-50 p-2 rounded border border-gray-200'; div.innerHTML = `<select class="c-type w-1/3 border p-1.5 text-xs rounded outline-none focus:border-swc-secondary bg-white">${optionsHtml}</select><input type="text" placeholder="Modelo" value="${model}" class="c-model w-1/3 border p-1.5 text-xs rounded outline-none focus:border-swc-secondary"><input type="text" placeholder="Serial" value="${serial}" class="c-serial w-1/3 border p-1.5 text-xs rounded outline-none focus:border-swc-secondary"><button type="button" onclick="this.parentElement.remove()" class="text-sem-error hover:text-red-700" title="Remover"><i class="ph ph-trash"></i></button>`; container.appendChild(div); }
        function addRam(model = '', gb = '', serial = '') { const container = document.getElementById('ram-container'); if (!container) return; const div = document.createElement('div'); div.className = 'ram-item flex gap-2 items-center bg-slate-50 p-2 rounded border border-gray-200'; div.innerHTML = `<input type="number" placeholder="GB (Ex: 16)" value="${gb}" class="r-gb w-1/4 border p-1.5 text-xs rounded outline-none focus:border-swc-secondary"><input type="text" placeholder="Modelo/Freq." value="${model}" class="r-model w-2/4 border p-1.5 text-xs rounded outline-none focus:border-swc-secondary"><input type="text" placeholder="Serial" value="${serial}" class="r-serial w-1/4 border p-1.5 text-xs rounded outline-none focus:border-swc-secondary"><button type="button" onclick="this.parentElement.remove()" class="text-sem-error hover:text-red-700" title="Remover"><i class="ph ph-trash"></i></button>`; container.appendChild(div); }        

        function validateStepStrict(data, status) { const purpose = data.purpose; const wf = cachedWorkflows.find(w => (w.purpose || '').toLowerCase() === (purpose || '').toLowerCase()); if(!wf) return true; const currentStepObj = wf.steps.find(s => s.name === status); if(!currentStepObj) return true; const missing = []; (currentStepObj.required || []).forEach(field => { let val = data[field]; if (field === 'disks' || field === 'cards' || field === 'ram') { if (!val || val.length === 0) missing.push(FIELD_LABELS[field]); } else if (field === 'qa_checklist') { if (data.qa_details && data.qa_details.trim() === '') missing.push('Problema constatado:'); } else { if (!val || val.toString().trim() === '') missing.push(FIELD_LABELS[field]); } }); if(missing.length > 0) { showToast(`Para "${status}", preencha: ${missing.join(', ')}`, 'error'); return false; } return true; }

        function processFiles(input, type) { if (input.files && input.files.length > 0) { Array.from(input.files).forEach(file => { const reader = new FileReader(); reader.onload = function(e) { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const MAX_WIDTH = 2000; const QUALITY = 0.9; let width = img.width; let height = img.height; if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); currentPhotos[type].push(canvas.toDataURL('image/jpeg', QUALITY)); renderPhotoGallery(type); }; } ; reader.readAsDataURL(file); }); } }

        let activeCameraType = null; let videoStream = null; let currentFacingMode = 'environment';
        async function startCamera(type) { activeCameraType = type; const modal = document.getElementById('camera-modal'); const video = document.getElementById('camera-video'); modal.classList.remove('hidden'); try { if (videoStream) videoStream.getTracks().forEach(t => t.stop()); videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode, width: { ideal: 1920 }, height: { ideal: 1080 } } }); video.srcObject = videoStream; } catch (err) { swcAlert("Erro", "Erro ao acessar câmera: " + err.message, "error"); closeCamera(); } }
        async function switchCameraSource() { currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user'; await startCamera(activeCameraType); }
        function capturePhoto() { const video = document.getElementById('camera-video'); const canvas = document.getElementById('camera-canvas'); canvas.width = video.videoWidth; canvas.height = video.videoHeight; const ctx = canvas.getContext('2d'); if (currentFacingMode === 'user') { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); } ctx.drawImage(video, 0, 0, canvas.width, canvas.height); if (!currentPhotos[activeCameraType]) currentPhotos[activeCameraType] = []; currentPhotos[activeCameraType].push(canvas.toDataURL('image/jpeg', 0.8)); renderPhotoGallery(activeCameraType); video.classList.add('opacity-50'); setTimeout(() => video.classList.remove('opacity-50'), 100); }
        function closeCamera() { const modal = document.getElementById('camera-modal'); const video = document.getElementById('camera-video'); if (videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; } video.srcObject = null; modal.classList.add('hidden'); }
        
        function renderPhotoGallery(type) { const container = document.getElementById(`gallery-${type}`); if (!container) return; container.innerHTML = currentPhotos[type].map((src, index) => `<div class="relative h-24 border rounded-lg overflow-hidden group bg-gray-50 shadow-sm hover:shadow-md transition"><img src="${src.startsWith('/uploads') ? src : src}" class="w-full h-full object-cover cursor-pointer hover:opacity-90 transition" onclick="openLightbox('${src.startsWith('/uploads') ? src : src}')"><button type="button" onclick="removePhoto('${type}', ${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition shadow-md z-10"><i class="ph ph-x"></i></button><div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[9px] px-2 py-0.5 opacity-0 group-hover:opacity-100 transition flex justify-center items-center gap-1 pointer-events-none"><i class="ph ph-magnifying-glass-plus"></i> Ampliar</div></div>`).join(''); }
        function openLightbox(src) { const modal = document.getElementById('lightbox-modal'); const img = document.getElementById('lightbox-img'); img.src = src; img.style.transform = 'scale(1)'; img.classList.remove('cursor-grab', 'cursor-grabbing'); img.classList.add('cursor-zoom-in'); modal.classList.remove('hidden'); }
        function closeLightbox(e) { if (e && e.target.id === 'lightbox-img') return; document.getElementById('lightbox-modal').classList.add('hidden'); document.getElementById('lightbox-img').src = ''; }
        function toggleZoom(e) { e.stopPropagation(); const img = e.target; if (img.style.transform === 'scale(2.5)') { img.style.transform = 'scale(1)'; img.classList.remove('cursor-zoom-out'); img.classList.add('cursor-zoom-in'); } else { img.style.transform = 'scale(2.5)'; img.classList.remove('cursor-zoom-in'); img.classList.add('cursor-zoom-out'); } }
        function removePhoto(type, index) { currentPhotos[type].splice(index, 1); renderPhotoGallery(type); }

        function renderServers(list) {
            const container = document.getElementById('servers-container');
            if(!list || list.length === 0) return container.innerHTML = '<div class="col-span-full text-center py-20 text-slate-400"><i class="ph ph-hard-drives text-5xl mb-4"></i><p>Nenhum servidor encontrado.</p></div>';
            const qaIcon = (val) => val ? '<i class="ph ph-check-circle text-sem-success text-sm"></i>' : '<i class="ph ph-circle text-slate-200 text-sm"></i>';

            container.innerHTML = list.map(i => {
                const wf = cachedWorkflows.find(w => (w.purpose || '').toLowerCase() === (i.purpose || '').toLowerCase());
                const steps = wf ? wf.steps.map(s => s.name) : (i.status ? [i.status] : ['Início']);
                const stepIndex = steps.indexOf(i.status);
                const isConcluido = i.status === 'Concluído';
                const isFinished = stepIndex >= steps.length - 1;

                let timelineHTML = '';
                if (!isConcluido) {
                    steps.forEach((step, idx) => {
                        let colorClass = 'bg-gray-200'; if (idx < stepIndex) colorClass = 'bg-swc-primary'; else if (idx === stepIndex) colorClass = 'bg-swc-secondary animate-pulse scale-125 shadow-sm';
                        let label = ''; if(idx === 0 || idx === steps.length -1 || idx === stepIndex) label = `<div class="absolute top-4 left-1/2 transform -translate-x-1/2 text-[8px] font-bold uppercase tracking-wide ${idx === stepIndex ? 'text-swc-secondary' : 'text-gray-400'}">${step.substring(0,8)}</div>`;
                        timelineHTML += `<div class="relative flex-1 flex items-center h-2 group" title="${step}"><div class="w-full h-1 ${idx <= stepIndex ? 'bg-swc-primary' : 'bg-gray-100'}"></div><div class="absolute left-0 w-3 h-3 rounded-full ${colorClass} transition-all z-10 border-2 border-white"></div>${label}</div>`;
                    });
                } else { timelineHTML = `<div class="w-full bg-sem-success/20 text-sem-success text-center text-xs font-bold py-1 rounded">PROCESSAMENTO CONCLUÍDO</div>`; }

                const specs = []; if(i.cpu) specs.push(`<span class="bg-swc-sidebar/10 text-swc-sidebar border border-swc-sidebar/20 px-1.5 py-0.5 rounded text-[10px] font-bold">${i.cpu}</span>`); if(i.ram && i.ram.length) specs.push(`<span class="bg-swc-secondary/10 text-swc-secondary border border-swc-secondary/20 px-1.5 py-0.5 rounded text-[10px] font-bold">${i.ram.length}x RAM</span>`);
                let btnAction = ''; if (isConcluido) { btnAction = `<span class="text-sem-success"><i class="ph ph-check-circle text-xl"></i></span>`; } else { const btnClass = isFinished ? 'bg-sem-success/10 text-sem-success hover:bg-sem-success hover:text-white' : 'bg-swc-secondary/10 text-swc-secondary hover:bg-swc-secondary hover:text-white'; const btnIcon = isFinished ? 'ph-check' : 'ph-caret-double-right'; btnAction = `<button type="button" onclick="advanceStatus(event, '${i.id}', '${i.status}')" class="w-8 h-8 rounded-full ${btnClass} flex items-center justify-center transition-colors shadow-sm" title="${isFinished ? 'Finalizar' : 'Avançar Etapa'}"><i class="ph ${btnIcon} text-sm"></i></button>`; }

                return `<div class="bg-white p-5 rounded-xl border ${isConcluido ? 'border-sem-success/30 ring-1 ring-sem-success/20' : 'border-gray-200'} shadow-sm hover:shadow-md transition-all mb-4 group relative overflow-visible cursor-pointer" onclick="navigateTo('pokeball', '${i.id}')"><div class="flex justify-between items-center mb-2"><div class="flex items-center gap-4 flex-1"><div class="w-10 h-10 rounded-lg bg-slate-50 border border-slate-200 flex items-center justify-center text-lg text-slate-400"><i class="ph ph-hard-drives"></i></div><div><h4 class="font-bold font-display text-base text-slate-800 flex items-center gap-2">${i.client || '<span class="italic text-slate-400 font-normal">Pendente</span>'}<span class="text-[10px] px-2 py-0.5 bg-slate-100 text-slate-500 rounded border border-slate-200 font-normal font-sans">${i.product || 'Prod'}</span></h4><div class="flex items-center gap-2 mt-1">${specs.join('')}</div></div></div><div class="flex items-center gap-3"><div class="text-right hidden sm:block"><p class="text-[10px] font-bold uppercase text-slate-400">Status</p><span class="text-xs font-bold ${isConcluido ? 'text-sem-success' : 'text-swc-secondary'}">${i.status}</span></div><button type="button" onclick="downloadReportNow(event, '${i.id}')" class="hidden md:flex w-8 h-8 items-center justify-center rounded-full hover:bg-swc-secondary/10 text-swc-secondary transition-colors" title="Gerar Relatório"><i class="ph ph-file-pdf text-lg"></i></button><button type="button" onclick="event.stopPropagation(); toggleDetails('${i.id}', this)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 transition-transform chevron-icon"><i class="ph ph-caret-down text-lg"></i></button>${btnAction}</div></div><div class="mt-6 mb-2 pl-14 pr-12 relative hidden md:block"><div class="flex items-center w-full">${timelineHTML}<div class="relative w-3 h-3"><div class="w-3 h-3 rounded-full ${isConcluido ? 'bg-sem-success' : 'bg-gray-200'} border-2 border-white relative z-10"></div></div></div></div><div id="details-${i.id}" class="details-content bg-white"><div class="mt-4 pt-4 border-t border-gray-100 grid grid-cols-1 md:grid-cols-3 gap-6 text-xs text-slate-600"><div class="space-y-2"><p class="font-bold text-slate-800 uppercase text-[10px] tracking-wider mb-2 flex items-center gap-1 font-display"><i class="ph ph-cpu text-swc-primary text-sm"></i> Sistema & Cliente</p><div class="bg-slate-50 p-2 rounded border border-slate-100 space-y-1"><p class="flex justify-between"><span>Cliente:</span> <span class="font-bold text-slate-700">${i.client || '-'}</span></p><p class="flex justify-between"><span>Hostname:</span> <span class="font-mono text-swc-secondary">${i.hostname || '-'}</span></p><p class="flex justify-between"><span>Tag/Serial:</span> <span class="font-mono">${i.serial || '-'}</span></p><div class="border-t border-slate-200 my-1"></div><p><span class="text-slate-400">OS:</span> ${i.os || '-'}</p><p><span class="text-slate-400">RAM:</span> ${i.ram && i.ram.length ? i.ram.reduce((acc, r) => acc + parseInt(r.gb || 0), 0) + 'GB Total' : '-'}</p></div></div><div class="space-y-2"><p class="font-bold text-slate-800 uppercase text-[10px] tracking-wider mb-2 flex items-center gap-1 font-display"><i class="ph ph-circuitry text-swc-primary text-sm"></i> Expansão</p><div class="space-y-1 max-h-24 overflow-y-auto custom-scrollbar pr-1">${i.disks && i.disks.length ? i.disks.map(d => `<div class="flex justify-between items-center bg-slate-50 px-2 py-1 rounded border border-slate-100"><span class="flex items-center gap-1"><i class="ph ph-hard-drive text-slate-400"></i> ${d.model}</span><span class="font-bold text-[10px]">${d.size}</span></div>`).join('') : '<span class="text-slate-400 italic pl-1">Sem discos</span>'} ${i.cards && i.cards.length ? i.cards.map(c => `<div class="flex justify-between items-center bg-slate-50 px-2 py-1 rounded border border-slate-100 mt-1"><span class="flex items-center gap-1"><i class="ph ph-video-camera text-slate-400"></i> ${c.type}</span><span class="font-bold text-[10px]">${c.model}</span></div>`).join('') : '<span class="text-slate-400 italic pl-1 block mt-1">Sem placas</span>'}</div></div><div class="space-y-2"><p class="font-bold text-slate-800 uppercase text-[10px] tracking-wider mb-2 flex items-center gap-1 font-display"><i class="ph ph-clipboard-text text-swc-primary text-sm"></i> QA & Rede</p><div class="flex justify-between items-center mb-2 bg-swc-primary/10 px-2 py-1 rounded border border-swc-primary/20 text-swc-primary"><span>IP Manutenção</span><span class="font-mono font-bold">${i.qa_ip || 'N/A'}</span></div><div class="grid grid-cols-2 gap-y-1 gap-x-2"><span class="flex items-center gap-1.5">${qaIcon(i.qa_func)} Funcional</span><span class="flex items-center gap-1.5">${qaIcon(i.qa_rails)} Trilhos</span><span class="flex items-center gap-1.5">${qaIcon(i.qa_cables)} Cabos</span><span class="flex items-center gap-1.5">${qaIcon(i.qa_stickers)} Etiquetas</span></div>${i.qa_details ? `<p class="mt-2 text-[10px] text-slate-500 italic truncate" title="${i.qa_details}"><i class="ph ph-info"></i> ${i.qa_details}</p>` : ''}</div></div></div></div>`;
            }).join('');
        }
        function toggleDetails(id, btn) { const content = document.getElementById(`details-${id}`); content.classList.toggle('open'); btn.classList.toggle('rotate'); }
        function applyServerFilter() { const filter = document.getElementById('server-filter').value; const term = document.getElementById('server-search').value?.toLowerCase() || ''; let filtered = allServers || []; if (filter !== 'Todos') { if (filter === 'Concluído') filtered = filtered.filter(s => s.status === 'Concluído'); else filtered = filtered.filter(s => s.status !== 'Concluído'); } if (term) filtered = filtered.filter(s => (s.client?.toLowerCase().includes(term)) || (s.hostname?.toLowerCase().includes(term)) || (s.serial?.toLowerCase().includes(term))); renderServers(filtered); }
        function renderTeam(list) { document.getElementById('team-container').innerHTML = list.map(u => `<div onclick="navigateTo('team', '${u.id}')" class="bg-white p-6 rounded-2xl border hover:shadow-md cursor-pointer flex flex-col items-center text-center group relative"><div class="w-16 h-16 rounded-full ${u.color || 'bg-gray-800'} text-white flex items-center justify-center text-xl font-bold mb-3 transition group-hover:scale-110 font-display">${u.initials}</div><h4 class="font-bold text-lg text-slate-800 font-display">${u.name}</h4><span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded mt-1">${u.role}</span></div>`).join(''); }
        function renderTMs(list) { document.getElementById('manuals-container').innerHTML = list.map(i => `<div onclick="navigateTo('tm', '${i.id}')" class="bg-white p-6 rounded-2xl border hover:shadow-md cursor-pointer group relative"><h4 class="font-bold text-lg mb-2 text-slate-800 font-display">${i.title}</h4><span class="text-xs bg-gray-100 px-2 py-1 rounded text-slate-500">${i.category}</span><p class="text-xs text-slate-400 mt-4 line-clamp-3 font-mono">${i.content}</p></div>`).join(''); }
        function renderRotinesList(list) { document.getElementById('rotines-list-container').innerHTML = list.map(i => `<div onclick="navigateTo('rotines', '${i.id}')" class="bg-white p-4 rounded border flex justify-between items-center cursor-pointer hover:bg-gray-50"><div><h4 class="font-bold text-lg text-slate-800 font-display">${i.title}</h4><p class="text-sm text-slate-500">${Array.isArray(i.assignedTo) ? i.assignedTo.join(', ') : i.assignedTo} | ${i.frequency}</p></div><i class="ph ph-caret-right text-slate-400"></i></div>`).join(''); }
        function renderTasks(list) {
            const c = document.getElementById('tasks-container');
            if(list.length === 0) return c.innerHTML = '<p class="text-gray-400 col-span-3 text-center py-10">Sem tarefas para esta data.</p>';
            const colors = { 'Diária': 'bg-swc-secondary/10 text-swc-secondary', 'Semanal': 'bg-swc-sidebar/10 text-swc-sidebar', 'Quinzenal': 'bg-swc-orange/10 text-swc-orange', 'Mensal': 'bg-swc-brown/10 text-swc-brown', 'Única': 'bg-sem-alert/10 text-sem-alert' };

            c.innerHTML = list.map((t, idx) => {
                const done = t.status === 'Concluído';
                const assignedToNames = Array.isArray(t.assignedTo) ? t.assignedTo : [t.assignedTo || 'T.I'];
                const assignedToDisplay = assignedToNames.join(', ');
                const user = cachedUsers.find(u => u.name === assignedToNames[0]);
                const initial = user ? user.initials : (assignedToNames[0] ? assignedToNames[0].substring(0,2).toUpperCase() : 'TI');
                let topIconsHTML = ''; let bottomButtonHTML = '';

                if (!done) {
                    topIconsHTML = `<div class="absolute top-4 right-4 flex gap-2 z-10"><button type="button" onclick="event.stopPropagation(); deleteItemFromList('${t.id}', 'tasks')" class="w-8 h-8 rounded-full flex items-center justify-center text-sem-error hover:bg-sem-error/10 transition-colors" title="Excluir"><i class="ph ph-trash text-lg"></i></button><button type="button" onclick="event.stopPropagation(); openEditModal('rotom', '${t.id}')" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-500 hover:bg-gray-100 transition-colors" title="Editar"><i class="ph ph-pencil-simple text-lg"></i></button></div>`;
                    bottomButtonHTML = `<button type="button" onclick="finishTask('${t.id}', this); event.stopPropagation();" class="mt-4 w-full bg-sem-success text-white text-sm font-bold py-2.5 rounded-xl hover:bg-black transition shadow-lg flex items-center justify-center gap-2"><i class="ph ph-check-circle"></i> Concluir Tarefa</button>`;
                }

                return `<div class="bg-white p-6 rounded-2xl border ${done ? 'opacity-60' : ''} relative" onclick="${done ? '' : `openEditModal('rotom', '${t.id}')`}" style="cursor:${done ? 'default' : 'pointer'};">${topIconsHTML}<div class="flex flex-col gap-2"><span class="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded-full border w-fit ${colors[t.frequency] || 'bg-gray-100'} mb-1 inline-block font-sans">${t.frequency || 'Rotina'}</span><h4 class="font-bold text-lg leading-tight text-slate-800 font-display">${t.title}</h4><div class="text-xs text-gray-500 mb-3 flex items-center gap-2"><div class="w-5 h-5 rounded-full bg-gray-200 flex items-center justify-center text-[9px] font-bold text-gray-600">${initial}</div>${assignedToDisplay}</div><ul class="space-y-2 mb-4 flex-1 overflow-y-auto max-h-40 custom-scrollbar pr-1">${t.checklist.map((step, sIdx) => `<li class="flex items-start gap-3 group"><div class="relative flex items-center pt-0.5"><input type="checkbox" class="peer appearance-none w-4 h-4 border border-gray-300 rounded checked:bg-swc-primary checked:border-swc-primary cursor-pointer transition-colors" ${step.completed ? 'checked' : ''} ${done ? 'disabled' : ''} onclick="event.stopPropagation()" onchange="toggleTaskStep('${t.id}', ${sIdx}, this.checked)"><i class="ph ph-check text-white text-[10px] absolute top-1 left-[3px] pointer-events-none opacity-0 peer-checked:opacity-100"></i></div><div class="flex-1"><span class="text-sm ${step.completed ? 'line-through text-gray-400' : 'text-gray-600 font-medium'} transition-colors select-none cursor-pointer" onclick="event.stopPropagation(); toggleTaskStep('${t.id}', ${sIdx}, !this.parentElement.previousElementSibling.querySelector('input').checked)">${step.step}</span>${step.manual ? `<div class="mt-1 hidden group-hover:block animate-fade-in"><div class="text-[10px] bg-sem-info/10 text-sem-info p-2 rounded border border-sem-info/20 font-mono"><i class="ph ph-info mr-1"></i> ${step.manual}</div></div>` : ''}</div></li>`).join('')}</ul>${t.notes ? `<div class="mt-2 text-xs bg-gray-100 p-2 rounded border border-gray-200 text-slate-600"><strong>Obs:</strong> ${t.notes}</div>` : ''}${!done && t.checklist.every(s => s.completed) ? bottomButtonHTML : ''}${done ? `<div class="mt-4 w-full bg-sem-success/10 text-sem-success text-sm font-bold py-2.5 rounded-xl flex items-center justify-center gap-2"><i class="ph ph-check-circle-fill"></i> Concluída</div>` : (t.checklist.every(s => s.completed) ? '' : `<button type="button" disabled class="mt-4 w-full bg-gray-200 text-gray-500 text-sm font-bold py-2.5 rounded-xl flex items-center justify-center gap-2"><i class="ph ph-lock"></i> Conclua todos os passos</button>`)}</div></div>`;
            }).join('');
        }

        async function startProduction(orderId) {
            if (!(await swcConfirm('Iniciar Produção?', 'Isso criará um novo Servidor na linha de produção para a T.I iniciar a montagem.', 'Sim, Iniciar', '#85B433'))) return;
            const order = allOrders.find(o => o.id === orderId); if(!order) return;
            try {
                let qaDetails = `[Ordem Comercial]\n`;
                if (order.services && order.services.length > 0) qaDetails += `Serviços Adicionais: ${order.services.join(', ')}\n`;
                if (order.observations) qaDetails += `Obs Comercial: ${order.observations}\n`;
                qaDetails += `Solicitante: ${order.requester?.name || 'Comercial'}`;
                if (cachedWorkflows.length === 0) { const wRes = await fetch(`${API}/workflows`); cachedWorkflows = await wRes.json(); }
                let wf = cachedWorkflows.find(w => (w.purpose || '').toLowerCase() === (order.contractType || '').toLowerCase());
                let initialStatus = (wf && wf.steps && wf.steps.length > 0) ? wf.steps[0].name : 'Início';
                const newServer = { client: order.client?.name || '', product: order.product?.description || '', purpose: order.contractType || '', status: initialStatus, userAction: currentUser.name, qa_details: qaDetails };
                const resServer = await fetch(`${API}/servers`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newServer) });
                const createdServer = await resServer.json();
                order.status = 'Em Produção'; order.linkedServerId = createdServer.id;
                await fetch(`${API}/orders/${orderId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(order) });
                showToast('Produção iniciada com sucesso!', 'success'); loadData('orders'); 
            } catch(e) { showToast('Erro ao iniciar produção.', 'error'); }
        }

        function renderOrders(list) {
            const container = document.getElementById('orders-container');
            if (!list || list.length === 0) return container.innerHTML = '<div class="text-center py-10 text-slate-400"><i class="ph ph-shopping-cart text-5xl mb-4"></i><p>Nenhuma solicitação encontrada.</p></div>';
            
            const role = (currentUser.role || '').toLowerCase(); 
            const isTI = role === 'admin' || role === 't.i' || role.includes('admin') || role.includes('t.i');
            
            container.innerHTML = list.map(o => {
                const statusColors = { 'Pendente': 'bg-sem-alert/10 text-sem-alert border-sem-alert/20', 'Em Produção': 'bg-swc-secondary/10 text-swc-secondary border-swc-secondary/20', 'Concluído': 'bg-sem-success/10 text-sem-success border-sem-success/20', 'Cancelado': 'bg-gray-100 text-gray-500 border-gray-200' };
                const badgeClass = statusColors[o.status] || 'bg-gray-100 text-gray-500'; 
                const dateStr = o.createdAt ? new Date(o.createdAt).toLocaleDateString('pt-BR') : '-';
                
                let bottomButtonHTML = '';
                if (o.status === 'Pendente') { 
                    if (isTI) { bottomButtonHTML = `<button type="button" onclick="event.stopPropagation(); startProduction('${o.id}')" class="mt-4 w-full bg-swc-secondary text-white text-sm font-bold py-2.5 rounded-xl hover:bg-black transition shadow-lg flex items-center justify-center gap-2"><i class="ph ph-rocket-launch text-lg"></i> Iniciar Montagem (T.I)</button>`; } 
                    else { bottomButtonHTML = `<div class="mt-4 w-full bg-sem-alert/10 text-sem-alert border border-sem-alert/20 text-sm font-bold py-2.5 rounded-xl flex items-center justify-center gap-2"><i class="ph ph-hourglass-medium text-lg"></i> Aguardando T.I Iniciar</div>`; } 
                } else if (o.status === 'Em Produção' && o.linkedServerId) { 
                    bottomButtonHTML = `<button type="button" onclick="event.stopPropagation(); navigateTo('status'); setTimeout(() => viewServerDetails('${o.linkedServerId}'), 100);" class="mt-4 w-full bg-swc-secondary/10 text-swc-secondary border border-swc-secondary/20 text-sm font-bold py-2.5 rounded-xl hover:bg-swc-secondary hover:text-white transition flex items-center justify-center gap-2"><i class="ph ph-monitor-play text-lg"></i> Ver Status da Produção</button>`; 
                }
                
                const isOwner = o.requester?.email === currentUser.email || o.requester?.name === currentUser.name; 
                const canDelete = isTI || isOwner;

                // --- ESTILO VISUAL DOS CARDS (O BRILHO LARANJA E BORDA) ---
                const isPending = o.status === 'Pendente';
                const cardStyle = isPending 
                    ? 'border-l-4 border-l-sem-alert border-y-gray-200 border-r-gray-200 shadow-[0_4px_15px_-3px_rgba(246,110,0,0.15)] hover:shadow-[0_4px_20px_-3px_rgba(246,110,0,0.25)]' 
                    : 'border border-gray-200 shadow-sm hover:shadow-md';

                // --- DADOS COMPLETOS DO CLIENTE ---
                let addr = {}; 
                try { addr = typeof o.client?.address === 'string' ? JSON.parse(o.client.address) : o.client?.address; } catch(e) { addr = { street: o.client?.address }; } 
                if (!addr) addr = {};
                const fullAddress = `${addr.street || ''}, ${addr.number || 'S/N'} - ${addr.city || ''}/${addr.state || ''} (CEP: ${addr.cep || ''})`.replace(/^, /, '').trim();
                const contractType = o.contractType || '-';

                return `<div class="bg-white p-5 rounded-xl transition-all cursor-pointer group relative ${cardStyle}" onclick="openEditModal('orders', '${o.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded border mb-2 inline-block ${badgeClass}">${o.status}</span>
                            <h4 class="font-bold text-lg text-slate-800 font-display">${o.client?.name || 'Cliente N/A'}</h4>
                            <p class="text-[11px] font-mono text-gray-500">${o.client?.cnpj || ''} ${o.client?.ie ? ' | IE: ' + o.client.ie : ''}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-gray-400 uppercase font-bold">Solicitante</p>
                            <p class="text-xs font-bold text-slate-700">${o.requester?.name || 'Vendedor'}</p>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 mb-3">
                        <div class="flex items-center gap-2 mb-1"><i class="ph ph-package text-swc-primary"></i><span class="text-sm font-bold text-slate-700">${o.product?.description || 'Produto Genérico'}</span></div>
                        <p class="text-xs text-gray-500 line-clamp-2 pl-6">${o.observations || ''}</p>
                        ${o.services && o.services.length > 0 ? `<div class="pl-6 mt-2 flex flex-wrap gap-1">${o.services.map(s => `<span class="bg-white border border-gray-200 text-gray-600 text-[9px] px-1.5 py-0.5 rounded font-bold">${s}</span>`).join('')}</div>` : ''}
                    </div>

                    <div class="mt-3 pt-3 border-t border-gray-100 grid grid-cols-1 md:grid-cols-2 gap-y-2 gap-x-4 text-xs text-slate-600">
                        <p><strong class="text-slate-400 block text-[9px] uppercase">Contato</strong> <i class="ph ph-user"></i> ${o.client?.contactName || '-'} <br><i class="ph ph-phone"></i> ${o.client?.contactPhone || '-'}</p>
                        <p><strong class="text-slate-400 block text-[9px] uppercase">E-mail</strong> <i class="ph ph-envelope-simple"></i> ${o.client?.contactEmail || '-'}</p>
                        <p class="col-span-1 md:col-span-2"><strong class="text-slate-400 block text-[9px] uppercase">Endereço</strong> <i class="ph ph-map-pin"></i> ${fullAddress !== ' - / (CEP: )' && fullAddress !== '- / (CEP: )' ? fullAddress : 'Não informado'}</p>
                        <p class="col-span-1 md:col-span-2"><strong class="text-slate-400 block text-[9px] uppercase">Contrato / Finalidade</strong> <i class="ph ph-file-text"></i> ${contractType}</p>
                    </div>

                    ${bottomButtonHTML}
                    ${o.status === 'Pendente' && canDelete ? `<div class="absolute top-4 right-4 hidden group-hover:flex gap-2"><button type="button" onclick="event.stopPropagation(); deleteItemFromList('${o.id}', 'orders')" class="w-8 h-8 rounded-full bg-white border border-sem-error/30 text-sem-error flex items-center justify-center hover:bg-sem-error hover:text-white transition shadow-sm" title="Excluir"><i class="ph ph-trash"></i></button></div>` : ''}
                </div>`;
            }).join('');
        }

        function applyOrderFilter() { 
            const term = document.getElementById('order-search').value.toLowerCase(); 
            const status = document.getElementById('order-filter').value; 
            
            let filtered = allOrders.filter(o => { 
                const matchesTerm = (o.client?.name || '').toLowerCase().includes(term) || (o.product?.description || '').toLowerCase().includes(term); 
                const matchesStatus = status === 'Todos' ? true : o.status === status; 
                return matchesTerm && matchesStatus; 
            }); 

            // ORDENAÇÃO: "Pendente" sempre no topo
            filtered.sort((a, b) => {
                const statusOrder = { 'Pendente': 1, 'Em Produção': 2, 'Concluído': 3, 'Cancelado': 4 };
                const weightA = statusOrder[a.status] || 99;
                const weightB = statusOrder[b.status] || 99;
                
                if (weightA !== weightB) return weightA - weightB; 
                return new Date(b.createdAt || 0) - new Date(a.createdAt || 0); 
            });

            renderOrders(filtered); 
        }

        async function deleteItemFromList(id, collection = 'tasks') {
            if (!(await swcConfirm('Confirmar exclusão?', 'Esta ação é irreversível e o item será apagado permanentemente.', 'Sim, excluir!', '#F6242A'))) return;
            try { 
                if (collection === 'orders') {
                    const order = allOrders.find(o => o.id === id);
                    if (order) { await fetch(`${API}/notify`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'order_canceled', orderId: order.id, client: order.client?.name || 'Cliente', product: order.product?.description || 'Produto', requester: currentUser.name, requesterEmail: currentUser.email, emails: order.notificationEmails }) }); }
                }
                await fetch(`${API}/${collection}/${id}`, { method: 'DELETE' }); 
                if(collection === 'tasks') loadData('rotom'); else if(collection === 'orders') loadData('orders'); 
                showToast('Item excluído!', 'success'); 
            } catch(e) { showToast('Erro ao excluir item.', 'error'); }
        }
        async function populateUserSelect(assignedUsers = []) {
            const container = document.getElementById('assignedTo-checkbox-container'); if(!container) return;
            if(cachedUsers.length === 0) { try { const r=await fetch(`${API}/users`); cachedUsers=await r.json(); } catch(e) { return; } }
            const currentAssigned = Array.isArray(assignedUsers) ? assignedUsers : [assignedUsers].filter(n => n);
            const tiUsers = cachedUsers.filter(u => { const r = (u.role || '').toLowerCase(); return r.includes('t.i') || r.includes('admin'); });
            if (tiUsers.length === 0) { container.innerHTML = '<p class="text-xs text-gray-400 p-2 col-span-full">Nenhum usuário de T.I/Admin encontrado.</p>'; } else {
                container.innerHTML = tiUsers.map(u => { const isChecked = currentAssigned.includes(u.name) ? 'checked' : ''; return `<label class="flex items-center gap-2 text-sm text-slate-700 cursor-pointer hover:bg-gray-50 rounded p-1 -m-1 transition-colors"><input type="checkbox" name="assignedTo" value="${u.name}" ${isChecked} class="w-4 h-4 text-swc-primary rounded focus:ring-swc-primary border-gray-300">${u.name}</label>`; }).join('');
            }
            if(container.closest('#tpl-rotine')) { container.classList.remove('grid-cols-2', 'md:grid-cols-2'); container.classList.add('grid-cols-1'); } else { container.classList.remove('grid-cols-1'); container.classList.add('grid-cols-1', 'md:grid-cols-2'); }
        }
        function renderServicesCheckboxes(selectedServices = []) {
            const container = document.getElementById('additional-services-container'); if(!container) return;
            const services = cachedOptions.filter(o => o.type === 'service');
            if (services.length === 0) { container.innerHTML = '<p class="text-xs text-gray-400 col-span-full mt-2">Nenhum serviço opcional cadastrado. Cadastre em Configurações.</p>'; return; }
            container.innerHTML = services.map(s => { const isChecked = selectedServices.includes(s.value) ? 'checked' : ''; return `<label class="flex items-center gap-2 text-xs text-slate-700 cursor-pointer hover:bg-gray-100 p-2 rounded transition border border-transparent hover:border-gray-200"><input type="checkbox" name="extraService" value="${s.value}" ${isChecked} class="w-4 h-4 text-swc-primary rounded focus:ring-swc-primary border-gray-300">${s.value}</label>`; }).join('');
        }

        function renderTMs(list) { document.getElementById('manuals-container').innerHTML = list.map(i => `<div onclick="navigateTo('tm', '${i.id}')" class="bg-white p-6 rounded-2xl border hover:shadow-md cursor-pointer group relative"><h4 class="font-bold text-lg mb-2 text-slate-800 font-display">${i.title}</h4><span class="text-xs bg-gray-100 px-2 py-1 rounded text-slate-500">${i.category}</span><p class="text-xs text-slate-400 mt-4 line-clamp-3 font-mono">${i.content}</p></div>`).join(''); }
        function renderRotinesList(list) { document.getElementById('rotines-list-container').innerHTML = list.map(i => `<div onclick="navigateTo('rotines', '${i.id}')" class="bg-white p-4 rounded border flex justify-between items-center cursor-pointer hover:bg-gray-50"><div><h4 class="font-bold text-lg text-slate-800 font-display">${i.title}</h4><p class="text-sm text-slate-500">${Array.isArray(i.assignedTo) ? i.assignedTo.join(', ') : i.assignedTo} | ${i.frequency}</p></div><i class="ph ph-caret-right text-slate-400"></i></div>`).join(''); }

        function renderStatusPanel() {
            const container = document.getElementById('status-container'); if (!container) return;
            const term = (document.getElementById('status-search')?.value || '').toLowerCase();
            let activeServers = allServers.filter(s => s.status !== 'Concluído' && s.status !== 'Cancelado');
            if (term) { activeServers = activeServers.filter(s => (s.client || '').toLowerCase().includes(term) || (s.serial || '').toLowerCase().includes(term) || (s.hostname || '').toLowerCase().includes(term) ); }
            if (activeServers.length === 0) { container.innerHTML = '<div class="col-span-full text-center py-10 text-slate-400"><i class="ph ph-coffee text-5xl mb-4"></i><p>Nenhum equipamento em montagem no momento.</p></div>'; return; }
            container.innerHTML = activeServers.map(s => {
                const linkedOrder = allOrders.find(o => o.linkedServerId === s.id); const clientCnpj = linkedOrder?.client?.cnpj || 'CNPJ Não informado'; const clientName = s.client || linkedOrder?.client?.name || 'Sem Cliente';
                let hwHtml = ''; if (s.vendor || s.model || s.serial) hwHtml += `<p class="mb-1"><strong>Base:</strong> ${s.vendor||''} ${s.model||''} <br><span class="text-[10px] uppercase text-gray-400">S/N:</span> <span class="font-mono text-swc-secondary font-bold">${s.serial||'Pendente'}</span></p>`; if (s.disks && s.disks.length) hwHtml += `<div class="mt-2 pt-2 border-t border-gray-200"><strong>Discos:</strong><br>` + s.disks.map(d => `<span class="text-slate-500">- ${d.size} ${d.model} <span class="font-mono text-[10px]">(S/N: ${d.serial || 'Pendente'})</span></span>`).join('<br>') + `</div>`; if (s.ram && s.ram.length) hwHtml += `<div class="mt-2 pt-2 border-t border-gray-200"><strong>Memória RAM:</strong><br>` + s.ram.map(r => `<span class="text-slate-500">- ${r.gb}GB ${r.model} <span class="font-mono text-[10px]">(S/N: ${r.serial || 'Pendente'})</span></span>`).join('<br>') + `</div>`; if (s.cards && s.cards.length) hwHtml += `<div class="mt-2 pt-2 border-t border-gray-200"><strong>Placas PCI:</strong><br>` + s.cards.map(c => `<span class="text-slate-500">- ${c.type} ${c.model} <span class="font-mono text-[10px]">(S/N: ${c.serial || 'Pendente'})</span></span>`).join('<br>') + `</div>`;
                if(!hwHtml) hwHtml = '<p class="text-gray-400 italic text-center py-4"><i class="ph ph-clock animate-pulse text-xl block mb-1"></i>Aguardando inclusão de peças</p>';
                return `<div onclick="viewServerDetails('${s.id}')" class="cursor-pointer bg-white p-5 rounded-xl border-2 border-swc-secondary/20 shadow-lg relative flex flex-col h-full hover:border-swc-secondary/50 transition-colors"><div class="mb-4"><span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded bg-swc-secondary/10 text-swc-secondary mb-2 inline-flex items-center gap-1"><i class="ph ph-gear animate-spin"></i> Etapa: ${s.status}</span><h4 class="font-bold text-lg text-slate-800 font-display leading-tight">${clientName}</h4><p class="text-xs font-mono font-bold text-slate-500 bg-slate-100 inline-block px-1.5 rounded mt-1">${clientCnpj}</p></div><div class="flex-1 bg-slate-50 p-3.5 rounded-lg border border-slate-200 text-xs text-slate-700 mb-4 overflow-y-auto custom-scrollbar max-h-56 shadow-inner"><div class="font-bold text-swc-sidebar mb-2 flex items-center gap-1.5 uppercase tracking-wide text-[10px]"><i class="ph ph-list-numbers text-sm"></i> Hardware para Faturamento</div>${hwHtml}</div><div class="text-[10px] text-gray-400 flex flex-col gap-1 pt-3 border-t border-gray-100"><div class="flex justify-between"><span>Produto:</span> <strong class="text-slate-600">${s.product || 'N/A'}</strong></div><div class="flex justify-between"><span>Técnico Responsável:</span> <strong class="text-slate-600">${s.userAction || 'T.I'}</strong></div></div></div>`;
            }).join('');
        }

        function renderFinishedPanel() {
            const container = document.getElementById('finished-container'); if (!container) return;
            
            // 1. Pega TODOS os equipamentos finalizados
            let finishedServers = allServers.filter(s => s.status === 'Concluído').reverse();

            // 2. MOTOR DINÂMICO DOS FILTROS (Lê o banco e cria as opções sozinho)
            const contractSelect = document.getElementById('finished-contract-filter');
            const productSelect = document.getElementById('finished-product-filter');
            
            if (contractSelect && productSelect) {
                const currentContract = contractSelect.value;
                const currentProduct = productSelect.value;
                
                const uniqueContracts = new Set();
                const uniqueProducts = new Set();
                
                finishedServers.forEach(s => {
                    const linkedOrder = allOrders.find(o => o.linkedServerId === s.id);
                    const cType = linkedOrder?.contractType || s.purpose;
                    if (cType && cType.trim() !== '') uniqueContracts.add(cType.trim());
                    if (s.product && s.product.trim() !== '') uniqueProducts.add(s.product.trim());
                });
                
                contractSelect.innerHTML = '<option value="">Todos os Contratos</option>' + 
                    [...uniqueContracts].sort().map(c => `<option value="${c}">${c}</option>`).join('');
                contractSelect.value = currentContract; 
                
                productSelect.innerHTML = '<option value="">Todos os Equipamentos</option>' + 
                    [...uniqueProducts].sort().map(p => `<option value="${p}">${p}</option>`).join('');
                productSelect.value = currentProduct;
            }

            // 3. LÊ O QUE O USUÁRIO DIGITOU OU ESCOLHEU NOS FILTROS
            const term = (document.getElementById('finished-search')?.value || '').toLowerCase();
            const contractFilter = contractSelect?.value || '';
            const productFilter = productSelect?.value || '';

            // 4. APLICA OS FILTROS PARA ESCONDER OS CARDS ERRADOS
            finishedServers = finishedServers.filter(s => {
                const linkedOrder = allOrders.find(o => o.linkedServerId === s.id);
                const matchTerm = term === '' || (s.client || '').toLowerCase().includes(term) || (s.serial || '').toLowerCase().includes(term) || (s.hostname || '').toLowerCase().includes(term);
                const matchContract = contractFilter === '' || (linkedOrder && linkedOrder.contractType === contractFilter) || (s.purpose === contractFilter);
                const matchProduct = productFilter === '' || (s.product || '').includes(productFilter);
                return matchTerm && matchContract && matchProduct;
            });

            if (finishedServers.length === 0) { 
                container.innerHTML = '<div class="col-span-full text-center py-10 text-slate-400"><i class="ph ph-package text-5xl mb-4"></i><p>Nenhum equipamento finalizado encontrado com estes filtros.</p></div>'; 
                return; 
            }
            
            const role = (currentUser.role || '').toLowerCase();
            const canAttachNF = role.includes('financeiro') || role.includes('admin');
            
            // 5. DESENHA OS CARDS NA TELA
            container.innerHTML = finishedServers.map(s => {
                const linkedOrder = allOrders.find(o => o.linkedServerId === s.id); 
                const clientCnpj = linkedOrder?.client?.cnpj || 'CNPJ Não informado'; 
                const clientName = s.client || linkedOrder?.client?.name || 'Sem Cliente';
                
                // MÁGICA VISUAL: Borda roxa se for Demonstração
                const isDemo = linkedOrder?.contractType?.toLowerCase().includes('demonstra') || (s.purpose || '').toLowerCase().includes('demonstra');
                const cardStyle = isDemo ? 'border-2 border-purple-400 shadow-[0_0_15px_rgba(168,85,247,0.15)] bg-purple-50/30' : 'border border-gray-200 bg-white';
                const demoBadge = isDemo ? `<span class="mt-2 text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded bg-purple-200 text-purple-800 flex items-center gap-1 w-max"><i class="ph ph-warning-circle text-sm"></i> MODO DEMONSTRAÇÃO</span>` : '';

                let pkgHtml = '';
                if (s.packageInfo) {
                    const dDate = s.packageInfo.deliveryDate ? s.packageInfo.deliveryDate.split('-').reverse().join('/') : '-';
                    pkgHtml = `
                    <div class="mt-4 bg-sem-success/5 p-3 rounded-lg border border-sem-success/20">
                        <p class="text-[10px] font-bold text-sem-success uppercase mb-2 flex items-center gap-1"><i class="ph ph-scales text-sm"></i> Faturamento & Frete</p>
                        <div class="grid grid-cols-2 gap-y-1.5 gap-x-2 text-xs text-slate-700">
                            <span><strong>Envio:</strong> ${s.packageInfo.deliveryMode || '-'}</span>
                            <span><strong>Data:</strong> ${dDate}</span>
                            <span><strong>Cx:</strong> ${s.packageInfo.length}x${s.packageInfo.width}x${s.packageInfo.depth} cm</span>
                            <span><strong>Peso:</strong> ${s.packageInfo.weight} kg</span>
                        </div>
                    </div>`;
                }

                // LÓGICA DO BOTÃO SUBSTITUIR NF
                let nfHtml = '';
                const orderId = linkedOrder ? linkedOrder.id : null;
                if (linkedOrder && linkedOrder.nfNumber) {
                    nfHtml = `
                    <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between items-center bg-green-50 p-2 rounded-lg border border-green-100">
                        <span class="text-xs font-bold text-slate-700 flex items-center gap-1"><i class="ph ph-receipt text-sem-success text-lg"></i> N.F: ${linkedOrder.nfNumber}</span>
                        <div class="flex gap-2">
                            ${canAttachNF ? `<button type="button" onclick="event.stopPropagation(); attachNF('${orderId}')" class="text-[10px] bg-white border border-green-300 text-green-700 px-2 py-1.5 rounded-md hover:bg-green-100 transition shadow-sm font-bold" title="Substituir N.F."><i class="ph ph-arrows-clockwise text-sm"></i></button>` : ''}
                            <a href="${linkedOrder.nfAttachment}" target="_blank" onclick="event.stopPropagation()" class="text-[10px] bg-sem-success text-white px-3 py-1.5 rounded-md hover:bg-green-600 transition shadow-sm font-bold flex items-center gap-1"><i class="ph ph-eye text-sm"></i> Ver</a>
                        </div>
                    </div>`;
                } else if (orderId && canAttachNF) {
                    nfHtml = `<div class="mt-3 pt-3 border-t border-gray-100"><button type="button" onclick="event.stopPropagation(); attachNF('${orderId}')" class="w-full border border-dashed border-gray-300 text-gray-500 hover:text-swc-primary hover:border-swc-primary hover:bg-swc-primary/5 p-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2"><i class="ph ph-upload-simple text-lg"></i> Anexar Nota Fiscal</button></div>`;
                } else if (orderId && !canAttachNF) {
                     nfHtml = `<div class="mt-3 pt-3 border-t border-gray-100 text-center text-[10px] text-gray-400 font-bold uppercase"><i class="ph ph-hourglass-high"></i> Aguardando Financeiro (N.F)</div>`;
                }

                return `
                <div onclick="viewServerDetails('${s.id}')" class="cursor-pointer p-5 rounded-xl shadow-sm hover:shadow-md transition-all relative flex flex-col h-full group ${cardStyle}">
                    <div class="mb-3">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded bg-sem-success/10 text-sem-success inline-flex items-center gap-1"><i class="ph ph-check-circle"></i> Concluído</span>
                            <button type="button" onclick="event.stopPropagation(); downloadReportNow(event, '${s.id}')" class="text-swc-secondary hover:bg-swc-secondary/10 p-1.5 rounded-full transition flex items-center gap-1 text-[10px] font-bold border border-transparent hover:border-swc-secondary/30" title="Baixar Laudo PDF"><i class="ph ph-file-pdf text-lg"></i> Laudo</button>
                        </div>
                        <h4 class="font-bold text-lg text-slate-800 font-display leading-tight line-clamp-1" title="${clientName}">${clientName}</h4>
                        <p class="text-xs font-mono font-bold text-slate-500 bg-slate-100 inline-block px-1.5 rounded mt-1">${clientCnpj}</p>
                        ${demoBadge}
                    </div>
                    
                    <div class="flex-1 text-xs text-slate-600 space-y-1.5 pt-2 border-t border-gray-100 mt-2">
                        <p class="truncate" title="${s.product || 'N/A'}"><strong>Produto:</strong> ${s.product || 'N/A'}</p>
                        <p><strong>Modelo:</strong> ${s.vendor||''} ${s.model||''}</p>
                        <p><strong>S/N:</strong> <span class="font-mono text-swc-secondary font-bold">${s.serial||'N/A'}</span></p>
                    </div>
                    
                    ${pkgHtml}
                    ${nfHtml}
                </div>`;
            }).join('');
        }

        async function renderModalForm(view, data) {
            const modal = document.getElementById('modal'); const content = document.getElementById('modal-content');
            let tplId = view === 'tm' ? 'tpl-manual' : (view === 'pokeball' ? 'tpl-server' : (view === 'team' ? 'tpl-team' : (view === 'rotom' ? 'tpl-task' : (view === 'orders' ? 'tpl-order' : 'tpl-rotine'))));
            const tplElement = document.getElementById(tplId); if (!tplElement) return;
            content.innerHTML = tplElement.innerHTML;

            if (cachedWorkflows.length === 0 && view === 'pokeball') { try { const wRes = await fetch(`${API}/workflows`); cachedWorkflows = await wRes.json(); } catch(e){} }
            modal.classList.remove('hidden'); content.classList.remove('scale-100', 'opacity-100'); content.classList.add('scale-100', 'opacity-100');
            const isEdit = !!data; if(document.getElementById('modal-title')) document.getElementById('modal-title').innerText = isEdit ? 'Editar' : 'Novo';

            if(isEdit) {
                const delBtn = document.getElementById('btn-delete');
                if(delBtn && view !== 'pokeball') {
                    if (view === 'orders') { const r = (currentUser.role || '').toLowerCase(); const isTI = r.includes('admin') || r.includes('t.i'); const isOwner = data.requester?.email === currentUser.email || data.requester?.name === currentUser.name; if (isTI || isOwner) delBtn.classList.remove('hidden'); } else { delBtn.classList.remove('hidden'); }
                }
                document.getElementById('item-id').value = data.id;
            }

            if(view === 'pokeball' || view === 'tm' || view === 'orders') await populateSelects();
            if(view === 'rotines' || view === 'rotom') { if(cachedTMs.length === 0) { try { const r = await fetch(`${API}/manuals`); cachedTMs = await r.json(); } catch(e){} } await populateUserSelect(isEdit ? data.assignedTo : []); }
            if(view === 'team') await populateUserSelect(isEdit ? data.assignedTo : []);

            if(view === 'orders') {
                try { 
                    const resServers = await fetch(`${API}/servers`); const allSrv = await resServers.json(); 
                    const activeServers = allSrv.filter(s => s.status !== 'Concluído'); 
                    if (isEdit && data.linkedServerId) { const linkedSrv = allSrv.find(s => s.id === data.linkedServerId); if (linkedSrv && linkedSrv.status === 'Concluído') activeServers.push(linkedSrv); }
                    const selLinked = document.getElementById('inp-linkedServer'); 
                    if (selLinked) { selLinked.innerHTML = '<option value="">Nenhum (Novo fluxo: a T.I iniciará a montagem)</option>' + activeServers.map(s => `<option value="${s.id}">${s.product || 'Servidor'} - ${s.client || 'Sem Cliente'} (SN: ${s.serial || 'N/A'}) [${s.status}]</option>`).join(''); if (isEdit && data.linkedServerId) selLinked.value = data.linkedServerId; } 
                } catch(e) {}
                
                const existingServices = (isEdit && data.services) ? data.services : []; renderServicesCheckboxes(existingServices);
                if (!isEdit) { setTimeout(() => { const reqInput = document.getElementById('inp-requesterName'); if(reqInput && currentUser) reqInput.value = currentUser.name; }, 100); }
                
                if (isEdit) {
                    document.getElementById('inp-clientName').value = data.client?.name || ''; document.getElementById('inp-clientCnpj').value = data.client?.cnpj || ''; document.getElementById('inp-clientIE').value = data.client?.ie || ''; document.getElementById('inp-clientContact').value = data.client?.contactName || '';
                    let addr = {}; try { addr = typeof data.client?.address === 'string' ? JSON.parse(data.client.address) : data.client?.address; } catch(e) { addr = { street: data.client?.address }; } if (!addr) addr = {};
                    document.getElementById('inp-clientCep').value = addr.cep || ''; document.getElementById('inp-clientStreet').value = addr.street || ''; document.getElementById('inp-clientNumber').value = addr.number || ''; document.getElementById('inp-clientCity').value = addr.city || ''; document.getElementById('inp-clientState').value = addr.state || '';
                    document.getElementById('inp-requesterName').value = data.requester?.name || ''; setTimeout(() => { document.getElementById('inp-orderProduct').value = data.product?.description || ''; document.getElementById('inp-contractType').value = data.contractType || ''; }, 100); document.getElementById('inp-productConfig').value = data.product?.configuration || ''; document.getElementById('inp-observations').value = data.observations || '';
                }

                if (cachedUsers.length === 0) { try { const r = await fetch(`${API}/users`); cachedUsers = await r.json(); } catch(e){} }
                const respContainer = document.getElementById('order-responsibles-container');
                if (respContainer) {
                    const commercialUsers = cachedUsers.filter(u => (u.role || '').toLowerCase().includes('comercial') || (u.role || '').toLowerCase().includes('admin'));
                    const savedEmails = (isEdit && data.notificationEmails) ? data.notificationEmails : [];
                    if (commercialUsers.length === 0) { respContainer.innerHTML = '<p class="text-xs text-gray-400 p-1">Nenhum usuário Comercial cadastrado.</p>'; } else {
                        respContainer.innerHTML = commercialUsers.map(u => { const isChecked = savedEmails.includes(u.email) ? 'checked' : ''; return `<label class="flex items-center gap-2 text-sm text-slate-700 cursor-pointer hover:bg-gray-50 p-1.5 rounded transition-colors border border-transparent hover:border-gray-200"><input type="checkbox" name="orderResponsibles" value="${u.email}" ${isChecked} class="w-4 h-4 text-swc-primary rounded border-gray-300">${u.name}</label>`; }).join('');
                    }
                }
            }
            
            if(view === 'pokeball') {
                currentPhotos = { server: [], box: [] };
                if(isEdit) {
                    ['hostname','client','product','purpose','vendor','model','serial','cpu','os'].forEach(k => { const el = document.getElementById('inp-'+k); if(el) { if (el.tagName === 'SELECT' && data[k] && !Array.from(el.options).some(opt => opt.value === data[k])) { el.add(new Option(data[k], data[k])); } el.value = data[k] || ''; } });
                    document.getElementById('inp-qa_ip').value = data.qa_ip || ''; if(document.getElementById('inp-qa_details')) document.getElementById('inp-qa_details').value = data.qa_details || '';
                    ['qa_func','qa_rails','qa_cables','qa_stickers','qa_db'].forEach(k => { document.getElementById('inp-'+k).checked = !!data[k]; });
                    if (data.server_photos && Array.isArray(data.server_photos)) currentPhotos.server = data.server_photos; else if (data.server_photo) currentPhotos.server.push(data.server_photo);
                    if (data.box_photos && Array.isArray(data.box_photos)) currentPhotos.box = data.box_photos; else if (data.box_photo) currentPhotos.box.push(data.box_photo);
                    renderPhotoGallery('server'); renderPhotoGallery('box'); updateWorkflowFromPurpose(data.purpose, data.status);
                    if(data.disks) data.disks.forEach(d => addDisk(d.size, d.model, d.serial)); if(data.cards) data.cards.forEach(c => addCard(c.type, c.model, c.serial)); if(data.ram) data.ram.forEach(r => addRam(r.model, r.gb, r.serial));
                    if(data.history?.length > 0 && view !== 'settings') { const list = document.getElementById('history-list'); if(list) { document.getElementById('history-section').classList.remove('hidden'); list.innerHTML = data.history.map((h, idx) => `<div class="mb-4 relative pl-4 border-l-2 border-slate-200 last:border-0"><div class="absolute -left-[5px] top-1.5 w-2.5 h-2.5 ${idx===0 ? 'bg-swc-primary' : 'bg-slate-300'} rounded-full border border-white"></div><p class="text-sm font-medium text-slate-700">${h.msg}</p><div class="flex gap-2 text-[10px] text-slate-400 mt-0.5"><span>${h.user}</span><span>${new Date(h.timestamp).toLocaleString('pt-BR')}</span></div></div>`).join(''); } }
                } else { setTimeout(() => { const defaultPurpose = document.getElementById('inp-purpose')?.value || ''; updateWorkflowFromPurpose(defaultPurpose); }, 100); addDisk(); renderPhotoGallery('server'); renderPhotoGallery('box'); }
            }
            else if(view === 'team' && isEdit) { ['name','role','initials','email','password'].forEach(k => document.getElementById('inp-'+k).value = data[k]); }
            else if(view === 'rotines' && isEdit) { ['title','frequency'].forEach(k => document.getElementById('inp-'+k).value = data[k]); const steps = data.steps || data.template || []; steps.forEach(s => addStep(s.title || s.step, s.manual)); }
            else if(view === 'rotom' && isEdit) { ['title','dueDate'].forEach(k => document.getElementById('inp-'+k).value = data[k]); document.getElementById('inp-notes').value = data.notes || ''; if(data.checklist) data.checklist.forEach(s => addStep(s.step, s.manual)); }
            else if(view === 'rotom' && !isEdit) { const datePicker = document.getElementById('date-picker'); if(datePicker && datePicker.value) document.getElementById('inp-dueDate').value = datePicker.value; }
            else if(view === 'tm' && isEdit) { ['title','category','content'].forEach(k => document.getElementById('inp-'+k).value = data[k]); }

            document.getElementById('form-generic').onsubmit = async (e) => { e.preventDefault(); await saveData(view, isEdit ? data.id : null); }
        }

        async function saveData(view, id) {
            let endpoint = view === 'tm' ? 'manuals' : (view === 'pokeball' ? 'servers' : (view === 'team' ? 'users' : (view === 'rotom' ? 'tasks' : (view === 'orders' ? 'orders' : 'rotines'))));
            let body = { userAction: currentUser.name }; const method = id ? 'PUT' : 'POST'; const url = id ? `${API}/${endpoint}/${id}` : `${API}/${endpoint}`;
            const getCheckedAssignedTo = () => { const checkboxes = document.querySelectorAll('#assignedTo-checkbox-container input[type="checkbox"]:checked'); return Array.from(checkboxes).map(cb => cb.value); };

            if(view === 'pokeball') {
                const status = document.getElementById('inp-status').value; const disks=[]; const cards=[]; const ram=[];
                document.querySelectorAll('.disk-item').forEach(div => disks.push({ size: div.querySelector('.d-size').value, model: div.querySelector('.d-model').value, serial: div.querySelector('.d-serial').value })); document.querySelectorAll('.card-item').forEach(div => cards.push({ type: div.querySelector('.c-type').value, model: div.querySelector('.c-model').value, serial: div.querySelector('.c-serial').value })); document.querySelectorAll('.ram-item').forEach(div => ram.push({ model: div.querySelector('.r-model').value, gb: div.querySelector('.r-gb').value, serial: div.querySelector('.r-serial').value }));
                Object.assign(body, { hostname: document.getElementById('inp-hostname').value, client: document.getElementById('inp-client').value, product: document.getElementById('inp-product').value, purpose: document.getElementById('inp-purpose').value, status, vendor: document.getElementById('inp-vendor').value, model: document.getElementById('inp-model').value, serial: document.getElementById('inp-serial').value, cpu: document.getElementById('inp-cpu').value, os: document.getElementById('inp-os').value, qa_ip: document.getElementById('inp-qa_ip').value, qa_details: document.getElementById('inp-qa_details') ? document.getElementById('inp-qa_details').value : '', qa_func: document.getElementById('inp-qa_func').checked, qa_rails: document.getElementById('inp-qa_rails').checked, qa_cables: document.getElementById('inp-qa_cables').checked, qa_stickers: document.getElementById('inp-qa_stickers').checked, qa_db: document.getElementById('inp-qa_db').checked, server_photos: currentPhotos.server, box_photos: currentPhotos.box, disks, cards, ram });
            }
            else if (view === 'team') { Object.assign(body, { name: document.getElementById('inp-name').value, role: document.getElementById('inp-role').value, initials: document.getElementById('inp-initials').value, email: document.getElementById('inp-email').value, password: document.getElementById('inp-password').value }); if(!id) body.color = ['bg-swc-sidebar','bg-swc-primary','bg-swc-secondary'][Math.floor(Math.random()*3)]; }
            else if (view === 'rotines') { const assignedTo = getCheckedAssignedTo(); if(assignedTo.length === 0) return showToast('Selecione pelo menos um responsável!', 'error'); const steps = []; document.querySelectorAll('.step-item').forEach(div => steps.push({ title: div.querySelector('.step-title').value, manual: div.querySelector('.step-manual').value })); Object.assign(body, { title: document.getElementById('inp-title').value, frequency: document.getElementById('inp-frequency').value, assignedTo: assignedTo, steps }); }
            else if (view === 'rotom') { const assignedTo = getCheckedAssignedTo(); if(assignedTo.length === 0) return showToast('Selecione pelo menos um responsável!', 'error'); const steps = []; document.querySelectorAll('.step-item').forEach(div => steps.push({ step: div.querySelector('.step-title').value, manual: div.querySelector('.step-manual').value, completed: false })); Object.assign(body, { title: document.getElementById('inp-title').value, dueDate: document.getElementById('inp-dueDate').value, assignedTo: assignedTo, frequency: 'Única', status: 'Pendente', checklist: steps, notes: document.getElementById('inp-notes').value }); }
            else if (view === 'tm') { Object.assign(body, { title: document.getElementById('inp-title').value, category: document.getElementById('inp-category').value, content: document.getElementById('inp-content').value }); }
            else if (view === 'orders') {
                const selectedResponsibles = []; document.querySelectorAll('input[name="orderResponsibles"]:checked').forEach(cb => selectedResponsibles.push(cb.value));
                if (currentUser && currentUser.email && !selectedResponsibles.includes(currentUser.email)) { selectedResponsibles.push(currentUser.email); }
                const selectedServices = []; document.querySelectorAll('input[name="extraService"]:checked').forEach(cb => selectedServices.push(cb.value)); const linkedServerId = document.getElementById('inp-linkedServer')?.value || null;
                const addrObj = { cep: document.getElementById('inp-clientCep').value, street: document.getElementById('inp-clientStreet').value, number: document.getElementById('inp-clientNumber').value, city: document.getElementById('inp-clientCity').value, state: document.getElementById('inp-clientState').value };
                
                Object.assign(body, {
                    client: { 
                        name: document.getElementById('inp-clientName').value, 
                        cnpj: document.getElementById('inp-clientCnpj').value, 
                        ie: document.getElementById('inp-clientIE')?.value || '', 
                        contactName: document.getElementById('inp-clientContact').value, 
                        contactPhone: document.getElementById('inp-clientPhone').value, 
                        contactEmail: document.getElementById('inp-clientEmail').value, 
                        address: JSON.stringify(addrObj) 
                    }, 
                    product: { description: document.getElementById('inp-orderProduct').value, qty: 1, configuration: document.getElementById('inp-productConfig').value }, 
                    contractType: document.getElementById('inp-contractType').value, 
                    notificationEmails: selectedResponsibles, 
                    observations: document.getElementById('inp-observations').value, 
                    services: selectedServices, 
                    requester: { name: document.getElementById('inp-requesterName').value, email: currentUser.email }, 
                    linkedServerId: linkedServerId, 
                    status: linkedServerId ? 'Em Produção' : (id ? undefined : 'Pendente')
                });
                
                if (id && !linkedServerId) { delete body.status; }
            }

            const submitBtn = document.querySelector('#form-generic button[type="submit"]'); let originalBtnText = "Salvar"; if(submitBtn) { originalBtnText = submitBtn.innerHTML; submitBtn.disabled = true; submitBtn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Processando...'; submitBtn.classList.add('opacity-70', 'cursor-not-allowed'); }
            try {
                const res = await fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
                if(res.ok) { 
                    const savedData = await res.json(); // <-- Pega os dados com o ID gerado
                    if (view === 'orders' && !id) { await fetch(`${API}/notify`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'order_created', orderId: savedData.id, client: body.client, product: body.product, contractType: body.contractType, services: body.services, observations: body.observations, requester: body.requester.name, requesterEmail: body.requester.email, emails: body.notificationEmails, isLinked: !!body.linkedServerId }) }); }
                    if (view === 'pokeball' && !id) { await fetch(`${API}/notify`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ type: 'server_created_manual', orderId: savedData.id, client: body.client, product: body.product, purpose: body.purpose, user: currentUser.name }) }); }
                    showToast('Dados salvos com sucesso!'); closeModal(); loadData(view); 
                } else { const error = await res.json(); showToast(`Erro ao salvar. ${error.error}`, 'error'); }
            } catch(e) { showToast(`Erro de conexão. ${e.message}`, 'error'); } 
            finally { if(submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText; submitBtn.classList.remove('opacity-70', 'cursor-not-allowed'); } }
        }

        async function advanceStatus(e, id, currentStatus) {
            e.stopPropagation(); const s = allServers.find(x => x.id === id); if(!s) return showToast('Servidor não encontrado localmente.', 'error');
            
            if(!validateStepStrict(s, currentStatus)) { openEditModal('pokeball', id); return; } 
            
            const wf = cachedWorkflows.find(w => (w.purpose || '').toLowerCase() === (s.purpose || '').toLowerCase()); if(!wf) return showToast('Fluxo não encontrado', 'error');
            const steps = wf.steps.map(st => st.name); const idx = steps.indexOf(currentStatus); let nextStep = idx >= steps.length - 1 ? 'Concluído' : steps[idx + 1]; let finishing = idx >= steps.length - 1;

            if (finishing) {
                try {
                    const ordersRes = await fetch(`${API}/orders`); const latestOrders = await ordersRes.json();
                    const linkedOrder = latestOrders.find(o => o.linkedServerId === id && o.status !== 'Concluído' && o.status !== 'Cancelado');
                    
                    if (!linkedOrder) { 
                        await swcAlert('Atenção: Solicitação Ausente', 'Este equipamento NÃO possui uma Solicitação Comercial atrelada ou ela já foi finalizada. O Comercial deve vincular a ordem de venda a este servidor antes que você possa gerar o Laudo de Saída.', 'error');
                        return; 
                    }

                    // --- INÍCIO DO MODAL DE EXPEDIÇÃO (OBRIGATÓRIO) ---
                    const { value: formValues } = await Swal.fire({
                        title: '📦 Dados de Expedição',
                        html: `
                            <div class="text-left text-sm text-slate-600 mb-4">Insira os dados logísticos para a emissão da NF e transporte.</div>
                            
                            <div class="grid grid-cols-2 gap-4 text-left mb-5 p-3 bg-gray-50 rounded-xl border border-gray-200">
                                <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Modo de Entrega</label>
                                    <select id="swal-delivery-mode" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-swc-primary focus:ring-1 focus:ring-swc-primary bg-white">
                                        <option value="">Selecione...</option>
                                        <option value="Transportadora">Transportadora</option>
                                        <option value="Envio próprio">Envio próprio</option>
                                    </select>
                                </div>
                                <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Previsão de Envio</label>
                                    <input id="swal-delivery-date" type="date" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-swc-primary focus:ring-1 focus:ring-swc-primary">
                                </div>
                            </div>

                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-2 text-left">Dimensões da Caixa</h4>
                            <div class="grid grid-cols-2 gap-4 text-left">
                                <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Comprimento (cm)</label><input id="swal-len" type="number" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-swc-primary focus:ring-1 focus:ring-swc-primary" placeholder="Ex: 80"></div>
                                <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Largura (cm)</label><input id="swal-wid" type="number" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-swc-primary focus:ring-1 focus:ring-swc-primary" placeholder="Ex: 60"></div>
                                <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Altura/Prof. (cm)</label><input id="swal-dep" type="number" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-swc-primary focus:ring-1 focus:ring-swc-primary" placeholder="Ex: 30"></div>
                                <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Peso Bruto (kg)</label><input id="swal-wei" type="number" step="0.1" class="w-full border border-gray-300 rounded-lg p-2.5 outline-none focus:border-swc-primary focus:ring-1 focus:ring-swc-primary" placeholder="Ex: 25.5"></div>
                            </div>
                        `,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonColor: '#85B433',
                        cancelButtonColor: '#94a3b8',
                        confirmButtonText: 'Finalizar Equipamento',
                        cancelButtonText: 'Cancelar',
                        customClass: { popup: 'font-sans rounded-2xl shadow-2xl', title: 'font-display text-slate-800' },
                        preConfirm: () => {
                            const len = document.getElementById('swal-len').value;
                            const wid = document.getElementById('swal-wid').value;
                            const dep = document.getElementById('swal-dep').value;
                            const wei = document.getElementById('swal-wei').value;
                            const dMode = document.getElementById('swal-delivery-mode').value;
                            const dDate = document.getElementById('swal-delivery-date').value;
                            
                            if (!len || !wid || !dep || !wei || !dMode || !dDate) { 
                                Swal.showValidationMessage('⚠️ Preencha todos os dados logísticos e medidas para finalizar.'); 
                                return false; 
                            }
                            return { length: len, width: wid, depth: dep, weight: wei, deliveryMode: dMode, deliveryDate: dDate };
                        }
                    });

                    if (!formValues) return; // Se o usuário clicar em "Cancelar", aborta a finalização
                    // --- FIM DO MODAL ---
                    
                    showToast('Finalizando processo e enviando relatórios...', 'info');
                    linkedOrder.status = 'Concluído'; await fetch(`${API}/orders/${linkedOrder.id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(linkedOrder) });
                    
                    // Salva os dados do status e também as medidas da caixa
                    await fetch(`${API}/servers/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ status: nextStep, userAction: currentUser.name, packageInfo: formValues }) });
                    const updatedS = await fetch(`${API}/servers/${id}`).then(r=>r.json()); const pdf = await window.generatePDFBlob(updatedS);
                    
                    // Passa o packageInfo para a notificação
                    await fetch(`${API}/notify`, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ type: 'server_dispatch', orderId: linkedOrder.id, hostname: updatedS.hostname, client: updatedS.client, fullClient: linkedOrder.client, product: updatedS.product, model: updatedS.model, serial: updatedS.serial, disks: updatedS.disks, ram: updatedS.ram, cards: updatedS.cards, status: 'Concluído', pdf: pdf, user: currentUser.name, details: updatedS.qa_details, orderEmails: linkedOrder.notificationEmails, clientContactEmail: linkedOrder.client?.contactEmail, packageInfo: formValues }) });
                    
                    showToast('Processo concluído e notificado!'); loadData('pokeball');
                } catch(e) { console.error(e); showToast('Erro na finalização integrada.', 'error'); }
            } else {
                if(!(await swcConfirm('Avançar Etapa?', `Deseja mover o equipamento para a próxima fase?`, 'Avançar', '#85B433'))) return;
                try { await fetch(`${API}/servers/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ status: nextStep, userAction: currentUser.name }) }); showToast(`Avançado para ${nextStep}`); loadData('pokeball'); } catch(e) { showToast('Erro ao avançar etapa', 'error'); }
            }
        }

        async function sendManualEmail(e, serverId) {
            if(e) e.stopPropagation(); if (!(await swcConfirm('Enviar Relatório?', 'Deseja disparar um e-mail interno com o laudo PDF atualizado deste equipamento?', 'Enviar Email', '#34B0B1'))) return; showToast('Gerando e enviando...', 'info');
            try {
                const res = await fetch(`${API}/servers/${serverId}`); const data = await res.json(); 
                const ordersRes = await fetch(`${API}/orders`); const allOrders = await ordersRes.json();
                const linkedOrder = allOrders.find(o => o.linkedServerId === serverId); const fullClient = linkedOrder ? linkedOrder.client : null;
                const pdfBase64 = await window.generatePDFBlob(data);
                const notifyRes = await fetch(`${API}/notify`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: 'server_dispatch', hostname: data.hostname, client: data.client, fullClient: fullClient, product: data.product, model: data.model, serial: data.serial, disks: data.disks, ram: data.ram, cards: data.cards, status: data.status, pdf: pdfBase64, user: currentUser.name, details: "Envio manual solicitado pelo usuário.", orderEmails: linkedOrder ? linkedOrder.notificationEmails : [] }) });
                if(notifyRes.ok) showToast('Relatório enviado com sucesso!'); else throw new Error('Falha');
            } catch(err) { console.error(err); showToast('Erro ao enviar relatório.', 'error'); }
        }

        async function downloadReportNow(e, serverId = null) {
            if(e) e.stopPropagation();
            try {
                showToast('Gerando PDF...', 'info');
                let data;
                
                // Verifica se o ID foi passado pelo painel ou se está aberto no modal
                if (serverId) {
                    const res = await fetch(`${API}/servers/${serverId}`);
                    if (!res.ok) throw new Error('Servidor não encontrado');
                    data = await res.json();
                } else {
                    const idInput = document.getElementById('item-id');
                    if (!idInput || !idInput.value) throw new Error('Salve o equipamento antes de gerar o laudo.');
                    const res = await fetch(`${API}/servers/${idInput.value}`);
                    data = await res.json();
                }

                // Chama o seu gerador de PDF (do arquivo report-generator.js)
                const pdfBase64 = await window.generatePDFBlob(data); 
                
                // Cria o gatilho invisível para baixar o arquivo no navegador
                const a = document.createElement('a');
                a.href = pdfBase64;
                
                // Formata o nome do arquivo bonitinho
                const safeProduct = (data.product || 'Equipamento').replace(/[^a-zA-Z0-9 -]/g, '');
                const safeClient = (data.client || 'Cliente').replace(/[^a-zA-Z0-9 -]/g, '');
                a.download = `Laudo_${safeProduct}_${safeClient}.pdf`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showToast('Download concluído!', 'success');
            } catch (err) {
                console.error("Erro no PDF:", err);
                showToast(err.message || 'Erro ao gerar relatório', 'error');
            }
        }
        
        async function attachNF(orderId) {
            const { value: formValues } = await Swal.fire({
                title: '🧾 Anexar Nota Fiscal',
                html: `
                    <div class="text-left mb-4 text-sm text-gray-600">Insira o número da N.F. e anexe o arquivo (PDF ou Imagem).</div>
                    <div class="mb-3 text-left">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Número da N.F.</label>
                        <input id="swal-nf-num" type="text" class="w-full border border-gray-300 rounded-lg p-3 outline-none focus:border-swc-primary focus:ring-1 focus:ring-swc-primary font-bold" placeholder="Ex: 001234">
                    </div>
                    <div class="text-left">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Arquivo (Upload)</label>
                        <input id="swal-nf-file" type="file" accept=".pdf,image/*" class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-gray-50 cursor-pointer">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#85B433',
                cancelButtonColor: '#94a3b8',
                confirmButtonText: 'Salvar N.F.',
                cancelButtonText: 'Cancelar',
                customClass: { popup: 'font-sans rounded-2xl', title: 'font-display text-slate-800' },
                preConfirm: async () => {
                    const num = document.getElementById('swal-nf-num').value;
                    const fileInput = document.getElementById('swal-nf-file');
                    if (!num) { Swal.showValidationMessage('⚠️ Digite o número da N.F.'); return false; }
                    if (!fileInput.files || fileInput.files.length === 0) { Swal.showValidationMessage('⚠️ Anexe o arquivo da N.F.'); return false; }
                    
                    const file = fileInput.files[0];
                    const base64 = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                    return { nfNumber: num, nfAttachment: base64 };
                }
            });

            if (formValues) {
                try {
                    const order = allOrders.find(o => o.id === orderId);
                    if(!order) return showToast('Ordem não encontrada', 'error');
                    
                    order.nfNumber = formValues.nfNumber;
                    order.nfAttachment = formValues.nfAttachment;
                    
                    Swal.fire({ title: 'Salvando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    
                    const res = await fetch(`${API}/orders/${orderId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(order)
                    });
                    
                    if (res.ok) {
                        showToast('N.F. anexada com sucesso!', 'success');
                        loadData('finished');
                        Swal.close();
                    } else { throw new Error('Falha ao salvar'); }
                } catch(e) { Swal.close(); showToast('Erro ao salvar N.F.', 'error'); }
            }
        }
    </script>
</body>
</html>